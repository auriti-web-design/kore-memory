<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kore — Memory Dashboard</title>
<link rel="icon" href="/favicon.svg" type="image/svg+xml">
<style>
/* ── Reset + Variabili ─────────────────────────────────────────────── */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg-primary: #09090b;
  --bg-secondary: #18181b;
  --bg-tertiary: #27272a;
  --bg-hover: #3f3f46;
  --border: #27272a;
  --border-hover: #3f3f46;
  --text: #fafafa;
  --text-muted: #a1a1aa;
  --text-dim: #71717a;
  --accent: #8b5cf6;
  --accent-hover: #a78bfa;
  --accent-muted: rgba(139, 92, 246, 0.15);
  --success: #10b981;
  --success-muted: rgba(16, 185, 129, 0.15);
  --warning: #f59e0b;
  --warning-muted: rgba(245, 158, 11, 0.15);
  --danger: #ef4444;
  --danger-muted: rgba(239, 68, 68, 0.15);
  --radius: 8px;
  --radius-lg: 12px;
  --radius-full: 9999px;
  --sidebar-w: 240px;
  --header-h: 65px;
  --font: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
  --font-mono: 'SF Mono', 'Cascadia Code', 'Fira Code', ui-monospace, monospace;
  --shadow: 0 1px 3px rgba(0,0,0,0.3);
  --shadow-lg: 0 8px 24px rgba(0,0,0,0.4);
  --transition: 0.2s ease;
}

/* ── Tema chiaro ──────────────────────────────────────────────────── */
[data-theme="light"] {
  --bg-primary: #fafafa;
  --bg-secondary: #ffffff;
  --bg-tertiary: #f4f4f5;
  --bg-hover: #e4e4e7;
  --border: #e4e4e7;
  --border-hover: #d4d4d8;
  --text: #18181b;
  --text-muted: #71717a;
  --text-dim: #a1a1aa;
  --accent: #7c3aed;
  --accent-hover: #6d28d9;
  --accent-muted: rgba(124, 58, 237, 0.1);
  --success: #059669;
  --success-muted: rgba(5, 150, 105, 0.1);
  --warning: #d97706;
  --warning-muted: rgba(217, 119, 6, 0.1);
  --danger: #dc2626;
  --danger-muted: rgba(220, 38, 38, 0.1);
  --shadow: 0 1px 3px rgba(0,0,0,0.06);
  --shadow-lg: 0 8px 24px rgba(0,0,0,0.1);
}

html { font-size: 14px; }
body {
  font-family: var(--font);
  background: var(--bg-primary);
  color: var(--text);
  min-height: 100vh;
  overflow: hidden;
  -webkit-font-smoothing: antialiased;
}

/* ── Scrollbar ────────────────────────────────────────────────────── */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border-hover); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--accent); }

/* ── Layout ───────────────────────────────────────────────────────── */
.app {
  display: grid;
  grid-template-columns: var(--sidebar-w) 1fr;
  grid-template-rows: var(--header-h) 1fr;
  height: 100vh;
}

/* ── Sidebar ──────────────────────────────────────────────────────── */
.sidebar {
  grid-row: 1 / -1;
  background: var(--bg-secondary);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  overflow-y: auto;
  z-index: 20;
}
.sidebar-brand {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 16px 20px;
  border-bottom: 1px solid var(--border);
  text-decoration: none;
  color: var(--text);
}
.sidebar-brand .logo {
  width: 32px; height: 32px;
  background: linear-gradient(135deg, #a78bfa, #7c3aed);
  border-radius: var(--radius);
  display: flex; align-items: center; justify-content: center;
  font-weight: 700; font-size: 16px; color: #fff;
  flex-shrink: 0;
}
.sidebar-brand span { font-weight: 600; font-size: 15px; letter-spacing: -0.3px; }
.sidebar-brand small { color: var(--text-dim); font-size: 11px; font-weight: 400; margin-left: auto; }

.sidebar-nav { flex: 1; padding: 8px; }
.nav-item {
  display: flex; align-items: center; gap: 10px;
  padding: 9px 12px; border-radius: var(--radius);
  color: var(--text-muted); cursor: pointer;
  transition: all var(--transition); font-size: 13px;
  border: none; background: none; width: 100%; text-align: left;
  font-family: inherit;
}
.nav-item:hover { background: var(--bg-tertiary); color: var(--text); }
.nav-item.active { background: var(--accent-muted); color: var(--accent); font-weight: 500; }
.nav-item svg { flex-shrink: 0; opacity: 0.7; }
.nav-item.active svg { opacity: 1; }

.sidebar-footer {
  padding: 12px 16px;
  border-top: 1px solid var(--border);
  display: flex; gap: 12px; align-items: center;
}
.sidebar-footer a {
  color: var(--text-dim); text-decoration: none; font-size: 12px;
  display: flex; align-items: center; gap: 4px;
  transition: color var(--transition);
}
.sidebar-footer a:hover { color: var(--accent); }

/* ── Header ───────────────────────────────────────────────────────── */
.header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 0 24px; background: var(--bg-secondary);
  border-bottom: 1px solid var(--border); z-index: 10;
}
.header-left { display: flex; align-items: center; gap: 16px; }
.header-title { font-weight: 600; font-size: 16px; color: var(--text); }
.header-right { display: flex; align-items: center; gap: 8px; }

.btn-hamburger {
  display: none; background: none; border: none; color: var(--text);
  cursor: pointer; padding: 6px; border-radius: var(--radius);
}
.btn-hamburger:hover { background: var(--bg-tertiary); }

/* ── Selettore agente ─────────────────────────────────────────────── */
.agent-select {
  background: var(--bg-tertiary); border: 1px solid var(--border);
  color: var(--text); padding: 6px 10px; border-radius: var(--radius);
  font-family: var(--font-mono); font-size: 12px; cursor: pointer;
  outline: none; transition: border-color var(--transition);
}
.agent-select:focus { border-color: var(--accent); }

/* ── Bottone tema ─────────────────────────────────────────────────── */
.btn-icon {
  background: none; border: 1px solid var(--border); color: var(--text-muted);
  width: 34px; height: 34px; border-radius: var(--radius);
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; transition: all var(--transition);
}
.btn-icon:hover { background: var(--bg-tertiary); color: var(--text); border-color: var(--border-hover); }

/* ── Main ─────────────────────────────────────────────────────────── */
.main {
  overflow-y: auto; padding: 24px;
  background: var(--bg-primary);
}

/* ── Pagine ────────────────────────────────────────────────────────── */
.page { display: none; animation: fadeIn 0.25s ease; }
.page.active { display: block; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }

/* ── Cards ─────────────────────────────────────────────────────────── */
.card {
  background: var(--bg-secondary); border: 1px solid var(--border);
  border-radius: var(--radius-lg); padding: 20px;
  transition: border-color var(--transition);
}
.card:hover { border-color: var(--border-hover); }
.card-title { font-weight: 600; font-size: 13px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px; }

/* ── Stats grid ───────────────────────────────────────────────────── */
.stats-grid {
  display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
  gap: 12px; margin-bottom: 24px;
}
.stat-card {
  background: var(--bg-secondary); border: 1px solid var(--border);
  border-radius: var(--radius-lg); padding: 16px 20px;
  transition: all var(--transition);
}
.stat-card:hover { border-color: var(--accent); box-shadow: 0 0 0 1px var(--accent-muted); }
.stat-label { font-size: 12px; color: var(--text-dim); margin-bottom: 4px; }
.stat-value { font-size: 28px; font-weight: 700; color: var(--text); line-height: 1.2; }
.stat-value.accent { color: var(--accent); }
.stat-value.success { color: var(--success); }
.stat-value.warning { color: var(--warning); }
.stat-sub { font-size: 11px; color: var(--text-dim); margin-top: 2px; }

/* ── Bottoni ──────────────────────────────────────────────────────── */
.btn {
  display: inline-flex; align-items: center; gap: 6px;
  padding: 8px 16px; border-radius: var(--radius); font-size: 13px;
  font-weight: 500; cursor: pointer; transition: all var(--transition);
  border: 1px solid transparent; font-family: inherit;
}
.btn-primary { background: var(--accent); color: #fff; border-color: var(--accent); }
.btn-primary:hover { background: var(--accent-hover); border-color: var(--accent-hover); }
.btn-secondary { background: var(--bg-tertiary); color: var(--text); border-color: var(--border); }
.btn-secondary:hover { background: var(--bg-hover); border-color: var(--border-hover); }
.btn-danger { background: var(--danger-muted); color: var(--danger); border-color: transparent; }
.btn-danger:hover { background: var(--danger); color: #fff; }
.btn-success { background: var(--success-muted); color: var(--success); border-color: transparent; }
.btn-success:hover { background: var(--success); color: #fff; }
.btn-sm { padding: 5px 10px; font-size: 12px; }
.btn-ghost { background: none; border: none; color: var(--text-muted); padding: 6px; }
.btn-ghost:hover { color: var(--text); background: var(--bg-tertiary); }
.btn:disabled { opacity: 0.5; cursor: not-allowed; }

/* ── Input / Form ─────────────────────────────────────────────────── */
.input, .textarea, .select {
  background: var(--bg-tertiary); border: 1px solid var(--border);
  color: var(--text); padding: 8px 12px; border-radius: var(--radius);
  font-family: inherit; font-size: 13px; width: 100%;
  outline: none; transition: border-color var(--transition);
}
.input:focus, .textarea:focus, .select:focus { border-color: var(--accent); }
.textarea { resize: vertical; min-height: 80px; }
.form-group { margin-bottom: 14px; }
.form-label { display: block; font-size: 12px; font-weight: 500; color: var(--text-muted); margin-bottom: 4px; }

/* ── Badge ─────────────────────────────────────────────────────────── */
.badge {
  display: inline-flex; align-items: center; padding: 2px 8px;
  border-radius: var(--radius-full); font-size: 11px; font-weight: 500;
}
.badge-general { background: rgba(139,92,246,0.15); color: #a78bfa; }
.badge-project { background: rgba(59,130,246,0.15); color: #60a5fa; }
.badge-trading { background: rgba(245,158,11,0.15); color: #fbbf24; }
.badge-finance { background: rgba(16,185,129,0.15); color: #34d399; }
.badge-person { background: rgba(236,72,153,0.15); color: #f472b6; }
.badge-preference { background: rgba(6,182,212,0.15); color: #22d3ee; }
.badge-task { background: rgba(249,115,22,0.15); color: #fb923c; }
.badge-decision { background: rgba(99,102,241,0.15); color: #818cf8; }
.badge-tag { background: var(--bg-tertiary); color: var(--text-muted); font-size: 12px; padding: 3px 10px; cursor: pointer; }
.badge-tag:hover { background: var(--accent-muted); color: var(--accent); }

/* ── Tabella ──────────────────────────────────────────────────────── */
.table-wrap { overflow-x: auto; }
table { width: 100%; border-collapse: collapse; }
th { text-align: left; font-size: 11px; font-weight: 600; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; padding: 10px 12px; border-bottom: 1px solid var(--border); }
td { padding: 10px 12px; border-bottom: 1px solid var(--border); font-size: 13px; color: var(--text); vertical-align: top; }
tr:hover td { background: var(--bg-tertiary); }

/* ── Importance dots ──────────────────────────────────────────────── */
.importance { display: flex; gap: 3px; }
.importance .dot {
  width: 8px; height: 8px; border-radius: 50%;
  background: var(--border); transition: background var(--transition);
}
.importance .dot.filled { background: var(--accent); }

/* ── Decay bar ────────────────────────────────────────────────────── */
.decay-bar { width: 60px; height: 4px; background: var(--bg-tertiary); border-radius: 2px; overflow: hidden; }
.decay-bar-fill { height: 100%; border-radius: 2px; transition: width 0.4s ease; }

/* ── Toolbar ──────────────────────────────────────────────────────── */
.toolbar {
  display: flex; align-items: center; gap: 10px;
  margin-bottom: 20px; flex-wrap: wrap;
}
.search-box {
  display: flex; align-items: center; gap: 8px;
  background: var(--bg-secondary); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 0 12px; flex: 1; max-width: 400px;
}
.search-box svg { color: var(--text-dim); flex-shrink: 0; }
.search-box input {
  background: none; border: none; color: var(--text);
  padding: 8px 0; font-size: 13px; width: 100%; outline: none;
  font-family: inherit;
}

/* ── Modal ─────────────────────────────────────────────────────────── */
.modal-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,0.6);
  display: none; align-items: center; justify-content: center;
  z-index: 100; backdrop-filter: blur(4px);
}
.modal-overlay.open { display: flex; }
.modal {
  background: var(--bg-secondary); border: 1px solid var(--border);
  border-radius: var(--radius-lg); padding: 24px; width: 90%;
  max-width: 520px; max-height: 85vh; overflow-y: auto;
  box-shadow: var(--shadow-lg); animation: modalIn 0.2s ease;
}
@keyframes modalIn { from { opacity: 0; transform: scale(0.96); } to { opacity: 1; transform: scale(1); } }
.modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
.modal-title { font-weight: 600; font-size: 16px; }
.modal-footer { display: flex; justify-content: flex-end; gap: 8px; margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--border); }

/* ── Toast ─────────────────────────────────────────────────────────── */
.toast-container { position: fixed; top: 16px; right: 16px; z-index: 200; display: flex; flex-direction: column; gap: 8px; }
.toast {
  padding: 12px 16px; border-radius: var(--radius); font-size: 13px;
  display: flex; align-items: center; gap: 8px;
  animation: toastIn 0.3s ease; min-width: 260px;
  box-shadow: var(--shadow-lg);
}
.toast-success { background: var(--success); color: #fff; }
.toast-error { background: var(--danger); color: #fff; }
.toast-info { background: var(--accent); color: #fff; }
@keyframes toastIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }

/* ── Empty state ──────────────────────────────────────────────────── */
.empty-state {
  display: flex; flex-direction: column; align-items: center;
  justify-content: center; padding: 48px 24px; color: var(--text-dim);
  text-align: center;
}
.empty-state svg { margin-bottom: 12px; opacity: 0.4; }
.empty-state p { font-size: 14px; max-width: 320px; }

/* ── Spinner ──────────────────────────────────────────────────────── */
.spinner { display: inline-block; width: 20px; height: 20px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.6s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
.loading-center { display: flex; justify-content: center; padding: 48px; }

/* ── Grid layout utilità ──────────────────────────────────────────── */
.grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
.grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
.flex-between { display: flex; justify-content: space-between; align-items: center; }
.mb-16 { margin-bottom: 16px; }
.mb-24 { margin-bottom: 24px; }

/* ── Memory card ──────────────────────────────────────────────────── */
.memory-card {
  background: var(--bg-secondary); border: 1px solid var(--border);
  border-radius: var(--radius-lg); padding: 16px; margin-bottom: 10px;
  transition: all var(--transition);
}
.memory-card:hover { border-color: var(--border-hover); }
.memory-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
.memory-card-content { font-size: 13px; color: var(--text); line-height: 1.5; margin-bottom: 10px; word-break: break-word; }
.memory-card-footer { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
.memory-card-footer .meta { font-size: 11px; color: var(--text-dim); display: flex; align-items: center; gap: 4px; }
.memory-card-actions { display: flex; gap: 4px; }

/* ── Azioni rapide ────────────────────────────────────────────────── */
.action-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 12px; }
.action-card {
  background: var(--bg-secondary); border: 1px solid var(--border);
  border-radius: var(--radius-lg); padding: 20px; cursor: pointer;
  transition: all var(--transition); text-align: left;
  font-family: inherit;
}
.action-card:hover { border-color: var(--accent); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
.action-card:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
.action-card h3 { font-size: 14px; font-weight: 600; margin-bottom: 4px; }
.action-card p { font-size: 12px; color: var(--text-dim); }

/* ── Distribuzione categorie ──────────────────────────────────────── */
.cat-bar-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
.cat-bar-label { font-size: 12px; color: var(--text-muted); width: 80px; text-align: right; }
.cat-bar-track { flex: 1; height: 8px; background: var(--bg-tertiary); border-radius: 4px; overflow: hidden; }
.cat-bar-fill { height: 100%; border-radius: 4px; transition: width 0.5s ease; }
.cat-bar-count { font-size: 12px; color: var(--text-dim); width: 32px; }

/* ── Grafo canvas ─────────────────────────────────────────────────── */
.graph-container { position: relative; }
#graph-canvas {
  width: 100%; height: calc(100vh - 200px);
  background: var(--bg-secondary); border: 1px solid var(--border);
  border-radius: var(--radius-lg); cursor: grab;
}
#graph-canvas.dragging { cursor: grabbing; }
#graph-canvas.hovering { cursor: pointer; }

/* Tooltip grafo */
.graph-tooltip {
  position: absolute; pointer-events: none;
  background: var(--bg-secondary); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 10px 14px;
  box-shadow: var(--shadow-lg); font-size: 12px;
  max-width: 300px; z-index: 30; display: none;
  transition: opacity 0.15s ease; opacity: 0;
}
.graph-tooltip.visible { display: block; opacity: 1; }
.graph-tooltip .tt-id { color: var(--accent); font-family: var(--font-mono); font-weight: 600; }
.graph-tooltip .tt-cat { margin-left: 6px; }
.graph-tooltip .tt-content { margin-top: 4px; color: var(--text); line-height: 1.4; }
.graph-tooltip .tt-relations { margin-top: 6px; padding-top: 6px; border-top: 1px solid var(--border); color: var(--text-dim); font-size: 11px; }

/* Pannello dettaglio nodo */
.graph-detail {
  position: absolute; top: 12px; right: 12px; width: 280px;
  background: var(--bg-secondary); border: 1px solid var(--border);
  border-radius: var(--radius-lg); padding: 16px;
  box-shadow: var(--shadow-lg); display: none; z-index: 25;
  max-height: calc(100% - 24px); overflow-y: auto;
}
.graph-detail.open { display: block; animation: fadeIn 0.2s ease; }
.graph-detail-close { position: absolute; top: 8px; right: 8px; }

/* Legenda grafo */
.graph-legend {
  display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;
  padding: 8px 12px; background: var(--bg-secondary);
  border: 1px solid var(--border); border-radius: var(--radius);
}
.graph-legend-item { display: flex; align-items: center; gap: 4px; font-size: 11px; color: var(--text-muted); }
.graph-legend-dot { width: 10px; height: 10px; border-radius: 50%; }

/* ── Sessioni ─────────────────────────────────────────────────────── */
.session-card {
  background: var(--bg-secondary); border: 1px solid var(--border);
  border-radius: var(--radius-lg); padding: 16px; margin-bottom: 10px;
  display: flex; justify-content: space-between; align-items: center;
  transition: border-color var(--transition);
}
.session-card:hover { border-color: var(--border-hover); }
.session-info h4 { font-size: 14px; margin-bottom: 2px; }
.session-info .meta { font-size: 12px; color: var(--text-dim); }

/* ── Timeline ─────────────────────────────────────────────────────── */
.timeline-item {
  display: flex; gap: 16px; padding: 16px 0;
  border-bottom: 1px solid var(--border);
}
.timeline-dot {
  width: 10px; height: 10px; border-radius: 50%;
  background: var(--accent); margin-top: 4px; flex-shrink: 0;
}
.timeline-content { flex: 1; }
.timeline-date { font-size: 11px; color: var(--text-dim); margin-bottom: 4px; }
.timeline-text { font-size: 13px; line-height: 1.5; }

/* ── Audit log ────────────────────────────────────────────────────── */
.audit-row { font-family: var(--font-mono); font-size: 12px; }
.audit-event { color: var(--accent); font-weight: 500; }
.audit-time { color: var(--text-dim); }

/* ── Tag cloud ────────────────────────────────────────────────────── */
.tag-cloud { display: flex; flex-wrap: wrap; gap: 6px; }

/* ── Responsive ───────────────────────────────────────────────────── */
@media (max-width: 768px) {
  .app { grid-template-columns: 1fr; }
  .sidebar {
    position: fixed; left: -260px; top: 0; bottom: 0;
    width: 260px; transition: left 0.3s ease;
    box-shadow: var(--shadow-lg);
  }
  .sidebar.open { left: 0; }
  .btn-hamburger { display: flex; }
  .main { padding: 16px; }
  .stats-grid { grid-template-columns: repeat(2, 1fr); }
  .grid-2, .grid-3 { grid-template-columns: 1fr; }
  .header-title { font-size: 14px; }
  .action-grid { grid-template-columns: 1fr; }
}

/* ── Focus visibile (accessibilità) ───────────────────────────────── */
:focus-visible {
  outline: 2px solid var(--accent);
  outline-offset: 2px;
}
button:focus:not(:focus-visible), a:focus:not(:focus-visible) { outline: none; }
</style>
</head>
<body>

<div class="app">
  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <a class="sidebar-brand" href="/dashboard">
      <div class="logo">K</div>
      <span>Kore</span>
      <small id="version-badge">v-</small>
    </a>
    <nav class="sidebar-nav" id="sidebar-nav"></nav>
    <div class="sidebar-footer">
      <a href="https://github.com/auriti-labs/kore-memory" target="_blank" rel="noopener" title="GitHub">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/></svg>
        GitHub
      </a>
      <a href="https://auritidesign.it/docs/kore-memory/" target="_blank" rel="noopener" title="Documentazione">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
        Docs
      </a>
    </div>
  </aside>

  <!-- Header -->
  <header class="header">
    <div class="header-left">
      <button class="btn-hamburger" id="btn-hamburger" aria-label="Menu">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
      </button>
      <h1 class="header-title" id="header-title">Overview</h1>
    </div>
    <div class="header-right">
      <select class="agent-select" id="agent-select" title="Seleziona agente">
        <option value="default">default</option>
      </select>
      <button class="btn-icon" id="btn-theme" title="Cambia tema" aria-label="Cambia tema">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" id="icon-theme"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
      </button>
    </div>
  </header>

  <!-- Contenuto principale -->
  <main class="main" id="main-content">

    <!-- PAGINA: Overview -->
    <section class="page active" data-page="overview">
      <div class="stats-grid" id="stats-grid"></div>
      <div class="grid-2 mb-24">
        <div class="card">
          <div class="card-title">Memorie recenti</div>
          <div id="recent-memories"></div>
        </div>
        <div class="card">
          <div class="card-title">Distribuzione categorie</div>
          <div id="category-dist"></div>
        </div>
      </div>
      <div class="card">
        <div class="card-title">Azioni rapide</div>
        <div class="action-grid" id="quick-actions"></div>
      </div>
    </section>

    <!-- PAGINA: Memories -->
    <section class="page" data-page="memories">
      <div class="toolbar">
        <div class="search-box">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
          <input type="text" id="mem-search" placeholder="Cerca memorie...">
        </div>
        <select class="select" id="mem-category" style="width:auto;min-width:120px">
          <option value="">Tutte</option>
          <option value="general">general</option>
          <option value="project">project</option>
          <option value="trading">trading</option>
          <option value="finance">finance</option>
          <option value="person">person</option>
          <option value="preference">preference</option>
          <option value="task">task</option>
          <option value="decision">decision</option>
        </select>
        <label style="display:flex;align-items:center;gap:4px;font-size:12px;color:var(--text-muted);cursor:pointer">
          <input type="checkbox" id="mem-semantic" checked> Semantic
        </label>
        <button class="btn btn-primary" id="btn-new-memory">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Nuova
        </button>
      </div>
      <div id="memories-list"></div>
    </section>

    <!-- PAGINA: Tags & Relations -->
    <section class="page" data-page="tags">
      <div class="grid-2">
        <div class="card">
          <div class="card-title">Tag</div>
          <div class="toolbar">
            <div class="search-box" style="max-width:100%">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
              <input type="text" id="tag-search" placeholder="Cerca tag...">
            </div>
          </div>
          <div class="tag-cloud" id="tag-cloud"></div>
          <div id="tag-memories" style="margin-top:16px"></div>
        </div>
        <div class="card">
          <div class="card-title">Relazioni</div>
          <div id="relations-list"></div>
          <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border)">
            <div class="card-title">Crea relazione</div>
            <div class="form-group">
              <label class="form-label">ID Sorgente</label>
              <input type="number" class="input" id="rel-source" placeholder="ID memoria sorgente">
            </div>
            <div class="form-group">
              <label class="form-label">ID Target</label>
              <input type="number" class="input" id="rel-target" placeholder="ID memoria target">
            </div>
            <div class="form-group">
              <label class="form-label">Tipo relazione</label>
              <input type="text" class="input" id="rel-type" value="related" placeholder="related, causes, requires...">
            </div>
            <button class="btn btn-primary" id="btn-add-relation">Crea relazione</button>
          </div>
        </div>
      </div>
    </section>

    <!-- PAGINA: Graph -->
    <section class="page" data-page="graph">
      <div class="toolbar">
        <button class="btn btn-secondary" id="btn-graph-reload">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
          Ricarica
        </button>
        <button class="btn btn-secondary" id="btn-graph-center">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M12 2v4m0 12v4M2 12h4m12 0h4"/></svg>
          Centra
        </button>
        <label style="display:flex;align-items:center;gap:4px;font-size:12px;color:var(--text-muted);cursor:pointer">
          <input type="checkbox" id="graph-show-labels" checked> Etichette
        </label>
        <label style="display:flex;align-items:center;gap:4px;font-size:12px;color:var(--text-muted);cursor:pointer">
          <input type="checkbox" id="graph-show-arrows" checked> Frecce
        </label>
        <span style="font-size:12px;color:var(--text-dim);margin-left:auto" id="graph-info">Nodi: 0 — Archi: 0</span>
      </div>
      <div class="graph-container">
        <canvas id="graph-canvas"></canvas>
        <div class="graph-tooltip" id="graph-tooltip">
          <div><span class="tt-id"></span><span class="tt-cat badge"></span></div>
          <div class="tt-content"></div>
          <div class="tt-relations"></div>
        </div>
        <div class="graph-detail" id="graph-detail">
          <button class="btn-ghost graph-detail-close" id="graph-detail-close" aria-label="Chiudi">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
          </button>
          <div id="graph-detail-content"></div>
        </div>
      </div>
      <div class="graph-legend" id="graph-legend"></div>
    </section>

    <!-- PAGINA: Sessions -->
    <section class="page" data-page="sessions">
      <div class="toolbar">
        <button class="btn btn-primary" id="btn-new-session">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Nuova sessione
        </button>
      </div>
      <div id="sessions-list"></div>
    </section>

    <!-- PAGINA: Timeline -->
    <section class="page" data-page="timeline">
      <div class="toolbar">
        <div class="search-box">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
          <input type="text" id="timeline-search" placeholder="Soggetto da cercare...">
        </div>
        <button class="btn btn-primary" id="btn-timeline-search">Cerca</button>
      </div>
      <div id="timeline-list"></div>
    </section>

    <!-- PAGINA: Maintenance -->
    <section class="page" data-page="maintenance">
      <div class="action-grid mb-24">
        <button class="action-card" id="btn-decay">
          <h3 style="color:var(--accent)">Run Decay</h3>
          <p>Ricalcola i punteggi di decadimento (Ebbinghaus)</p>
        </button>
        <button class="action-card" id="btn-compress">
          <h3 style="color:var(--success)">Comprimi</h3>
          <p>Unisci memorie simili (cosine similarity)</p>
        </button>
        <button class="action-card" id="btn-cleanup">
          <h3 style="color:var(--warning)">Cleanup TTL</h3>
          <p>Rimuovi memorie scadute</p>
        </button>
        <button class="action-card" id="btn-autotune">
          <h3 style="color:var(--danger)">Auto-Tune</h3>
          <p>Ottimizza importance basata su accesso</p>
        </button>
      </div>
      <div class="grid-2 mb-24">
        <div class="card">
          <div class="card-title">Scoring Stats</div>
          <div id="scoring-stats"></div>
        </div>
        <div class="card">
          <div class="card-title">Archivio</div>
          <div id="archive-list"></div>
        </div>
      </div>
      <div class="card">
        <div class="card-title">Export / Import</div>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn btn-secondary" id="btn-export">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
            Export JSON
          </button>
          <label class="btn btn-secondary" style="cursor:pointer">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
            Import JSON
            <input type="file" id="import-file" accept=".json" style="display:none">
          </label>
        </div>
      </div>
    </section>

    <!-- PAGINA: Settings -->
    <section class="page" data-page="settings">
      <div class="grid-2 mb-24">
        <div class="card">
          <div class="card-title">Agenti</div>
          <div id="agents-list"></div>
        </div>
        <div class="card">
          <div class="card-title">Server Info</div>
          <div id="server-info"></div>
        </div>
      </div>
      <div class="card mb-24">
        <div class="flex-between mb-16">
          <div class="card-title" style="margin-bottom:0">Audit Log</div>
          <div style="display:flex;gap:8px;align-items:center">
            <select class="select" id="audit-event-filter" style="width:auto;min-width:120px">
              <option value="">Tutti gli eventi</option>
              <option value="save">save</option>
              <option value="search">search</option>
              <option value="delete">delete</option>
              <option value="update">update</option>
              <option value="decay">decay</option>
              <option value="compress">compress</option>
            </select>
            <button class="btn btn-sm btn-secondary" id="btn-audit-refresh">Aggiorna</button>
          </div>
        </div>
        <div class="table-wrap" id="audit-table"></div>
      </div>
      <div class="card">
        <div class="card-title">Metriche Prometheus</div>
        <pre id="metrics-display" style="font-family:var(--font-mono);font-size:12px;color:var(--text-muted);white-space:pre-wrap;padding:12px;background:var(--bg-tertiary);border-radius:var(--radius);overflow-x:auto"></pre>
      </div>
    </section>

  </main>
</div>

<!-- Modal Crea/Modifica Memoria -->
<div class="modal-overlay" id="modal-memory">
  <div class="modal">
    <div class="modal-header">
      <span class="modal-title" id="modal-memory-title">Nuova memoria</span>
      <button class="btn-ghost" id="modal-memory-close" aria-label="Chiudi">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="form-group">
      <label class="form-label">Contenuto</label>
      <textarea class="textarea" id="modal-mem-content" rows="4" placeholder="Contenuto della memoria..."></textarea>
    </div>
    <div class="grid-2">
      <div class="form-group">
        <label class="form-label">Categoria</label>
        <select class="select" id="modal-mem-category">
          <option value="general">general</option>
          <option value="project">project</option>
          <option value="trading">trading</option>
          <option value="finance">finance</option>
          <option value="person">person</option>
          <option value="preference">preference</option>
          <option value="task">task</option>
          <option value="decision">decision</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Importanza (1=auto)</label>
        <select class="select" id="modal-mem-importance">
          <option value="1">1 — Auto</option>
          <option value="2">2 — Bassa</option>
          <option value="3">3 — Media</option>
          <option value="4">4 — Alta</option>
          <option value="5">5 — Critica</option>
        </select>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">TTL (ore, opzionale)</label>
      <input type="number" class="input" id="modal-mem-ttl" placeholder="Lascia vuoto per nessuna scadenza" min="1" max="8760">
    </div>
    <div class="form-group">
      <label class="form-label">Tags (separati da virgola)</label>
      <input type="text" class="input" id="modal-mem-tags" placeholder="tag1, tag2, tag3">
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" id="modal-mem-cancel">Annulla</button>
      <button class="btn btn-primary" id="modal-mem-save">Salva</button>
    </div>
  </div>
</div>

<!-- Modal Crea Sessione -->
<div class="modal-overlay" id="modal-session">
  <div class="modal">
    <div class="modal-header">
      <span class="modal-title">Nuova sessione</span>
      <button class="btn-ghost" id="modal-session-close" aria-label="Chiudi">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="form-group">
      <label class="form-label">Session ID</label>
      <input type="text" class="input" id="modal-sess-id" placeholder="es. session-2026-02-25">
    </div>
    <div class="form-group">
      <label class="form-label">Titolo (opzionale)</label>
      <input type="text" class="input" id="modal-sess-title" placeholder="Titolo della sessione">
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" id="modal-sess-cancel">Annulla</button>
      <button class="btn btn-primary" id="modal-sess-save">Crea</button>
    </div>
  </div>
</div>

<!-- Toast container -->
<div class="toast-container" id="toast-container"></div>

<script>
/* ═══════════════════════════════════════════════════════════════════════
   Kore Dashboard — Vanilla JS Application
   Zero dipendenze, CSP-compliant, accessibile
   ═══════════════════════════════════════════════════════════════════════ */

/* ── Stato applicazione ────────────────────────────────────────────── */
const state = {
  currentPage: 'overview',
  agentId: 'default',
  theme: localStorage.getItem('kore-theme') || 'dark',
  version: '',
  semanticEnabled: false,
  editingMemoryId: null,
};

/* ── Colori categorie ──────────────────────────────────────────────── */
const CAT_COLORS = {
  general: '#8b5cf6', project: '#3b82f6', trading: '#f59e0b', finance: '#10b981',
  person: '#ec4899', preference: '#06b6d4', task: '#f97316', decision: '#6366f1'
};

/* ── Pagine e navigazione ──────────────────────────────────────────── */
const PAGES = [
  { id: 'overview', label: 'Overview', icon: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>' },
  { id: 'memories', label: 'Memorie', icon: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>' },
  { id: 'tags', label: 'Tags & Relazioni', icon: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>' },
  { id: 'graph', label: 'Grafo', icon: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>' },
  { id: 'sessions', label: 'Sessioni', icon: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>' },
  { id: 'timeline', label: 'Timeline', icon: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>' },
  { id: 'maintenance', label: 'Manutenzione', icon: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>' },
  { id: 'settings', label: 'Impostazioni', icon: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" y1="21" x2="4" y2="14"/><line x1="4" y1="10" x2="4" y2="3"/><line x1="12" y1="21" x2="12" y2="12"/><line x1="12" y1="8" x2="12" y2="3"/><line x1="20" y1="21" x2="20" y2="16"/><line x1="20" y1="12" x2="20" y2="3"/><line x1="1" y1="14" x2="7" y2="14"/><line x1="9" y1="8" x2="15" y2="8"/><line x1="17" y1="16" x2="23" y2="16"/></svg>' },
];

/* ── Utilità DOM sicure ────────────────────────────────────────────── */
/* Escape HTML — previene XSS usando textContent del browser */
function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
function $(sel) { return document.querySelector(sel); }
function $$(sel) { return document.querySelectorAll(sel); }
function truncate(s, n) { n = n || 150; return s.length > n ? s.slice(0, n) + '\u2026' : s; }

/* Render sicuro: costruisce HTML con valori escaped via esc() */
function safeRender(target, html) {
  var el = typeof target === 'string' ? $(target) : target;
  if (el) el.innerHTML = html;
}

function fmtDate(d) {
  if (!d) return '\u2014';
  var dt = new Date(d);
  return dt.toLocaleDateString('it-IT', { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });
}
function fmtDateShort(d) {
  if (!d) return '\u2014';
  return new Date(d).toLocaleDateString('it-IT', { day: '2-digit', month: 'short' });
}
function decayColor(score) {
  if (score >= 0.7) return 'var(--success)';
  if (score >= 0.3) return 'var(--warning)';
  return 'var(--danger)';
}
function importanceDots(n) {
  var out = '';
  for (var i = 0; i < 5; i++) out += '<div class="dot ' + (i < n ? 'filled' : '') + '"></div>';
  return out;
}

/* ── API Client ────────────────────────────────────────────────────── */
var api = {
  request: function(method, path, body) {
    var headers = { 'X-Agent-Id': state.agentId };
    if (body) headers['Content-Type'] = 'application/json';
    return fetch(path, {
      method: method, headers: headers,
      body: body ? JSON.stringify(body) : null
    }).then(function(res) {
      if (res.status === 204) return null;
      if (!res.ok) {
        return res.json().catch(function() { return { detail: res.statusText }; }).then(function(err) {
          throw new Error(err.detail || err.error || 'Errore API');
        });
      }
      var ct = res.headers.get('content-type') || '';
      return ct.indexOf('json') >= 0 ? res.json() : res.text();
    }).catch(function(e) {
      if (e.message === 'Failed to fetch') throw new Error('Server non raggiungibile');
      throw e;
    });
  },
  get: function(p) { return api.request('GET', p); },
  post: function(p, b) { return api.request('POST', p, b); },
  put: function(p, b) { return api.request('PUT', p, b); },
  del: function(p, b) { return api.request('DELETE', p, b); },
};

/* ── Toast ─────────────────────────────────────────────────────────── */
function toast(msg, type) {
  type = type || 'info';
  var el = document.createElement('div');
  el.className = 'toast toast-' + type;
  el.textContent = msg;
  $('#toast-container').appendChild(el);
  setTimeout(function() { el.style.opacity = '0'; setTimeout(function() { el.remove(); }, 300); }, 3500);
}

/* ── Tema ──────────────────────────────────────────────────────────── */
function applyTheme() {
  document.documentElement.setAttribute('data-theme', state.theme);
  var iconEl = $('#icon-theme');
  if (state.theme === 'dark') {
    iconEl.innerHTML = '<circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>';
  } else {
    iconEl.innerHTML = '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>';
  }
}

/* ── Navigazione ───────────────────────────────────────────────────── */
function initNav() {
  var nav = $('#sidebar-nav');
  var html = '';
  PAGES.forEach(function(p) {
    html += '<button class="nav-item ' + (p.id === state.currentPage ? 'active' : '') + '" data-nav="' + p.id + '">' + p.icon + '<span>' + esc(p.label) + '</span></button>';
  });
  safeRender(nav, html);
  nav.addEventListener('click', function(e) {
    var btn = e.target.closest('[data-nav]');
    if (btn) navigate(btn.dataset.nav);
  });
}

function navigate(pageId) {
  state.currentPage = pageId;
  $$('.nav-item').forEach(function(el) { el.classList.toggle('active', el.dataset.nav === pageId); });
  $$('.page').forEach(function(el) { el.classList.toggle('active', el.dataset.page === pageId); });
  var page = PAGES.find(function(p) { return p.id === pageId; });
  $('#header-title').textContent = page ? page.label : '';
  $('#sidebar').classList.remove('open');
  loadPageData(pageId);
}

function loadPageData(pageId) {
  switch (pageId) {
    case 'overview': return loadOverview();
    case 'memories': return loadMemories();
    case 'tags': return loadTags();
    case 'graph': return loadGraph();
    case 'sessions': return loadSessions();
    case 'maintenance': return loadMaintenance();
    case 'settings': return loadSettings();
  }
}

/* ═══════════════════════════════════════════════════════════════════════
   PAGINA: Overview
   ═══════════════════════════════════════════════════════════════════════ */
function loadOverview() {
  Promise.all([
    api.get('/health'),
    api.get('/search?q=*&limit=20&semantic=false'),
    api.get('/agents'),
    api.get('/stats/scoring').catch(function() { return null; }),
    api.get('/archive?limit=1').catch(function() { return { total: 0 }; }),
  ]).then(function(results) {
    var health = results[0], searchRes = results[1], agents = results[2], scoring = results[3], arch = results[4];

    state.version = health.version || '';
    state.semanticEnabled = health.semantic_search || false;
    $('#version-badge').textContent = 'v' + state.version;

    var totalMem = searchRes.total || 0;
    var agentCount = agents ? agents.length : 0;
    var avgImp = scoring ? (scoring.avg_importance || 0).toFixed(1) : '\u2014';
    var semStatus = state.semanticEnabled ? 'Attivo' : 'Off';
    var archivedCount = arch.total || 0;

    safeRender('#stats-grid',
      '<div class="stat-card"><div class="stat-label">Memorie totali</div><div class="stat-value accent">' + totalMem + '</div></div>' +
      '<div class="stat-card"><div class="stat-label">Agenti</div><div class="stat-value">' + agentCount + '</div></div>' +
      '<div class="stat-card"><div class="stat-label">Archiviate</div><div class="stat-value">' + archivedCount + '</div></div>' +
      '<div class="stat-card"><div class="stat-label">Importanza media</div><div class="stat-value warning">' + esc(avgImp) + '</div></div>' +
      '<div class="stat-card"><div class="stat-label">Ricerca semantica</div><div class="stat-value ' + (state.semanticEnabled ? 'success' : '') + '">' + semStatus + '</div></div>' +
      '<div class="stat-card"><div class="stat-label">Versione</div><div class="stat-value" style="font-size:20px">' + esc(state.version) + '</div></div>'
    );

    /* Memorie recenti */
    var recent = (searchRes.results || []).slice(0, 6);
    if (recent.length) {
      var rhtml = '';
      recent.forEach(function(m) {
        rhtml += '<div style="padding:8px 0;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:flex-start;gap:8px">' +
          '<div style="flex:1;min-width:0"><div style="font-size:13px;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">' + esc(truncate(m.content, 80)) + '</div>' +
          '<div style="font-size:11px;color:var(--text-dim);margin-top:2px">' + fmtDateShort(m.created_at) + '</div></div>' +
          '<span class="badge badge-' + esc(m.category) + '">' + esc(m.category) + '</span></div>';
      });
      safeRender('#recent-memories', rhtml);
    } else {
      safeRender('#recent-memories', '<div class="empty-state"><p>Nessuna memoria trovata</p></div>');
    }

    /* Distribuzione categorie */
    var cats = {};
    (searchRes.results || []).forEach(function(m) { cats[m.category] = (cats[m.category] || 0) + 1; });
    var maxCat = Math.max.apply(null, Object.values(cats).concat([1]));
    var catEntries = Object.entries(cats).sort(function(a, b) { return b[1] - a[1]; });

    if (catEntries.length) {
      var chtml = '';
      catEntries.forEach(function(entry) {
        var cat = entry[0], count = entry[1];
        chtml += '<div class="cat-bar-row"><span class="cat-bar-label">' + esc(cat) + '</span>' +
          '<div class="cat-bar-track"><div class="cat-bar-fill" style="width:' + (count/maxCat*100).toFixed(0) + '%;background:' + (CAT_COLORS[cat]||'var(--accent)') + '"></div></div>' +
          '<span class="cat-bar-count">' + count + '</span></div>';
      });
      safeRender('#category-dist', chtml);
    } else {
      safeRender('#category-dist', '<div class="empty-state"><p>Nessun dato</p></div>');
    }

    /* Azioni rapide */
    safeRender('#quick-actions',
      '<button class="action-card" data-action="decay"><h3 style="color:var(--accent)">Run Decay</h3><p>Ricalcola punteggi decadimento</p></button>' +
      '<button class="action-card" data-action="compress"><h3 style="color:var(--success)">Comprimi</h3><p>Unisci memorie simili</p></button>' +
      '<button class="action-card" data-action="cleanup"><h3 style="color:var(--warning)">Cleanup TTL</h3><p>Rimuovi memorie scadute</p></button>' +
      '<button class="action-card" data-action="autotune"><h3 style="color:var(--danger)">Auto-Tune</h3><p>Ottimizza importanza</p></button>'
    );
    $('#quick-actions').querySelectorAll('[data-action]').forEach(function(btn) {
      btn.addEventListener('click', function() { runMaintenanceAction(btn.dataset.action); });
    });

  }).catch(function(e) {
    toast('Errore caricamento overview: ' + e.message, 'error');
  });
}

/* ═══════════════════════════════════════════════════════════════════════
   PAGINA: Memories
   ═══════════════════════════════════════════════════════════════════════ */
var memSearchTimeout = null;

function loadMemories(query) {
  var q = query || ($('#mem-search') ? $('#mem-search').value.trim() : '') || '*';
  var cat = $('#mem-category') ? $('#mem-category').value : '';
  var semantic = $('#mem-semantic') ? $('#mem-semantic').checked : true;
  var list = $('#memories-list');

  safeRender(list, '<div class="loading-center"><div class="spinner"></div></div>');

  var url = '/search?q=' + encodeURIComponent(q) + '&limit=20&semantic=' + semantic;
  if (cat) url += '&category=' + encodeURIComponent(cat);

  api.get(url).then(function(data) {
    if (!data.results || !data.results.length) {
      safeRender(list, '<div class="empty-state"><p>Nessuna memoria trovata. Prova un\'altra ricerca.</p></div>');
      return;
    }

    var html = '';
    data.results.forEach(function(m) {
      html += '<div class="memory-card" data-id="' + m.id + '">' +
        '<div class="memory-card-header"><div style="display:flex;gap:8px;align-items:center">' +
        '<span class="badge badge-' + esc(m.category) + '">' + esc(m.category) + '</span>' +
        '<span style="font-size:11px;color:var(--text-dim)">#' + m.id + '</span></div>' +
        '<div class="memory-card-actions">' +
        '<button class="btn-ghost btn-sm" title="Modifica" data-edit="' + m.id + '"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>' +
        '<button class="btn-ghost btn-sm" title="Archivia" data-archive="' + m.id + '"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="21 8 21 21 3 21 3 8"/><rect x="1" y="3" width="22" height="5"/><line x1="10" y1="12" x2="14" y2="12"/></svg></button>' +
        '<button class="btn-ghost btn-sm" title="Elimina" data-delete="' + m.id + '" style="color:var(--danger)"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>' +
        '</div></div>' +
        '<div class="memory-card-content">' + esc(m.content) + '</div>' +
        '<div class="memory-card-footer">' +
        '<div class="importance" title="Importanza: ' + m.importance + '/5">' + importanceDots(m.importance) + '</div>' +
        '<div style="display:flex;align-items:center;gap:4px" title="Decay: ' + (m.decay_score*100).toFixed(0) + '%">' +
        '<div class="decay-bar"><div class="decay-bar-fill" style="width:' + (m.decay_score*100).toFixed(0) + '%;background:' + decayColor(m.decay_score) + '"></div></div>' +
        '<span style="font-size:10px;color:var(--text-dim)">' + (m.decay_score*100).toFixed(0) + '%</span></div>' +
        '<span class="meta">' + fmtDate(m.created_at) + '</span>' +
        '</div></div>';
    });
    safeRender(list, html);

    /* Event handlers */
    list.querySelectorAll('[data-edit]').forEach(function(btn) {
      btn.addEventListener('click', function() { openEditMemory(parseInt(btn.dataset.edit)); });
    });
    list.querySelectorAll('[data-archive]').forEach(function(btn) {
      btn.addEventListener('click', function() {
        api.post('/memories/' + btn.dataset.archive + '/archive').then(function() {
          toast('Memoria archiviata', 'success'); loadMemories();
        }).catch(function(e) { toast(e.message, 'error'); });
      });
    });
    list.querySelectorAll('[data-delete]').forEach(function(btn) {
      btn.addEventListener('click', function() {
        if (!confirm('Eliminare questa memoria?')) return;
        api.del('/memories/' + btn.dataset.delete).then(function() {
          toast('Memoria eliminata', 'success'); loadMemories();
        }).catch(function(e) { toast(e.message, 'error'); });
      });
    });

  }).catch(function(e) {
    safeRender(list, '<div class="empty-state"><p>Errore: ' + esc(e.message) + '</p></div>');
  });
}

function openEditMemory(id) {
  var card = document.querySelector('.memory-card[data-id="' + id + '"]');
  if (!card) return;
  state.editingMemoryId = id;
  $('#modal-memory-title').textContent = 'Modifica memoria #' + id;
  $('#modal-mem-content').value = card.querySelector('.memory-card-content').textContent;
  var catEl = card.querySelector('.badge');
  if (catEl) $('#modal-mem-category').value = catEl.textContent.trim();
  $('#modal-mem-importance').value = card.querySelectorAll('.dot.filled').length || 1;
  $('#modal-mem-ttl').value = '';
  $('#modal-mem-tags').value = '';
  $('#modal-memory').classList.add('open');
}

/* ═══════════════════════════════════════════════════════════════════════
   PAGINA: Tags & Relations
   ═══════════════════════════════════════════════════════════════════════ */
function loadTags() {
  api.get('/search?q=*&limit=20&semantic=false').then(function(data) {
    var tagMap = {};
    var promises = (data.results || []).map(function(m) {
      return api.get('/memories/' + m.id + '/tags').then(function(t) {
        (t.tags || []).forEach(function(tag) {
          if (!tagMap[tag]) tagMap[tag] = { count: 0 };
          tagMap[tag].count++;
        });
      }).catch(function() {});
    });

    return Promise.all(promises).then(function() {
      var cloud = $('#tag-cloud');
      var tags = Object.entries(tagMap).sort(function(a, b) { return b[1].count - a[1].count; });

      if (tags.length) {
        var html = '';
        tags.forEach(function(entry) {
          html += '<span class="badge badge-tag" data-tag="' + esc(entry[0]) + '" title="' + entry[1].count + ' memorie">' + esc(entry[0]) + ' (' + entry[1].count + ')</span>';
        });
        safeRender(cloud, html);
        cloud.querySelectorAll('[data-tag]').forEach(function(el) {
          el.addEventListener('click', function() {
            api.get('/tags/' + encodeURIComponent(el.dataset.tag) + '/memories').then(function(res) {
              var h = '<div class="card-title" style="margin-top:8px">Memorie con tag "' + esc(el.dataset.tag) + '"</div>';
              (res.results || []).forEach(function(m) {
                h += '<div style="padding:8px 0;border-bottom:1px solid var(--border)"><span style="font-size:12px;color:var(--text-dim)">#' + m.id + '</span> <span style="font-size:13px">' + esc(truncate(m.content, 100)) + '</span></div>';
              });
              safeRender('#tag-memories', h);
            }).catch(function(e) { toast(e.message, 'error'); });
          });
        });
      } else {
        safeRender(cloud, '<div class="empty-state"><p>Nessun tag trovato</p></div>');
      }

      /* Relazioni */
      loadRelations(data.results || []);
    });
  }).catch(function(e) {
    toast('Errore caricamento tags: ' + e.message, 'error');
  });
}

function loadRelations(memories) {
  var allRel = [];
  var promises = memories.slice(0, 20).map(function(m) {
    return api.get('/memories/' + m.id + '/relations').then(function(r) {
      (r.relations || []).forEach(function(rel) { allRel.push(rel); });
    }).catch(function() {});
  });

  Promise.all(promises).then(function() {
    if (allRel.length) {
      var html = '';
      allRel.forEach(function(r) {
        html += '<div style="padding:8px 0;border-bottom:1px solid var(--border);font-size:13px">' +
          '<span style="color:var(--accent)">#' + r.source_id + '</span> ' +
          '<span style="color:var(--text-dim)">\u2192</span> ' +
          '<span class="badge badge-tag">' + esc(r.relation) + '</span> ' +
          '<span style="color:var(--text-dim)">\u2192</span> ' +
          '<span style="color:var(--accent)">#' + r.target_id + '</span></div>';
      });
      safeRender('#relations-list', html);
    } else {
      safeRender('#relations-list', '<div class="empty-state" style="padding:24px"><p>Nessuna relazione trovata</p></div>');
    }
  });
}

/* ═══════════════════════════════════════════════════════════════════════
   PAGINA: Graph (Force-directed interattivo)
   Drag nodi, zoom/pan, hover tooltip, click dettaglio, frecce direzionali
   ═══════════════════════════════════════════════════════════════════════ */
var graphNodes = [], graphEdges = [], graphAnim = null;
var graphState = {
  zoom: 1, panX: 0, panY: 0,
  dragNode: null, hoveredNode: null, selectedNode: null,
  isPanning: false, lastMouse: null,
  showLabels: true, showArrows: true,
  settled: false, iteration: 0
};

/* Coordinate mouse → coordinate grafo (applica zoom/pan) */
function screenToGraph(canvas, mx, my) {
  var rect = canvas.getBoundingClientRect();
  var sx = (mx - rect.left);
  var sy = (my - rect.top);
  return {
    x: (sx - canvas.width/2) / graphState.zoom - graphState.panX + canvas.width/2,
    y: (sy - canvas.height/2) / graphState.zoom - graphState.panY + canvas.height/2
  };
}

/* Trova nodo sotto il cursore */
function hitTestNode(gx, gy) {
  for (var i = graphNodes.length - 1; i >= 0; i--) {
    var n = graphNodes[i];
    var r = 6 + n.importance * 2.5;
    var dx = gx - n.x, dy = gy - n.y;
    if (dx*dx + dy*dy <= r*r) return n;
  }
  return null;
}

function loadGraph() {
  var canvas = $('#graph-canvas');
  var ctx = canvas.getContext('2d');
  canvas.width = canvas.offsetWidth * (window.devicePixelRatio || 1);
  canvas.height = canvas.offsetHeight * (window.devicePixelRatio || 1);
  canvas.style.width = canvas.offsetWidth + 'px';
  canvas.style.height = canvas.offsetHeight + 'px';
  ctx.scale(window.devicePixelRatio || 1, window.devicePixelRatio || 1);
  var w = canvas.offsetWidth, h = canvas.offsetHeight;

  /* Reset stato */
  graphState.zoom = 1; graphState.panX = 0; graphState.panY = 0;
  graphState.dragNode = null; graphState.hoveredNode = null;
  graphState.selectedNode = null; graphState.settled = false; graphState.iteration = 0;

  api.get('/search?q=*&limit=20&semantic=false').then(function(data) {
    var memories = data.results || [];
    /* Distribuisci nodi in cerchio per layout iniziale migliore */
    graphNodes = memories.map(function(m, i) {
      var angle = (2 * Math.PI * i) / memories.length;
      var radius = Math.min(w, h) * 0.3;
      return {
        id: m.id, label: truncate(m.content, 25), fullContent: m.content,
        category: m.category, importance: m.importance,
        decay_score: m.decay_score, created_at: m.created_at,
        x: w/2 + Math.cos(angle) * radius,
        y: h/2 + Math.sin(angle) * radius,
        vx: 0, vy: 0
      };
    });
    graphEdges = [];

    var promises = memories.map(function(m) {
      return api.get('/memories/' + m.id + '/relations').then(function(r) {
        (r.relations || []).forEach(function(rel) {
          if (graphNodes.find(function(n) { return n.id === rel.target_id; })) {
            graphEdges.push({ source: m.id, target: rel.target_id, label: rel.relation });
          }
        });
      }).catch(function() {});
    });

    return Promise.all(promises).then(function() {
      $('#graph-info').textContent = 'Nodi: ' + graphNodes.length + ' \u2014 Archi: ' + graphEdges.length;

      /* Legenda categorie presenti */
      var catsUsed = {};
      graphNodes.forEach(function(n) { catsUsed[n.category] = true; });
      var legendHtml = '';
      Object.keys(catsUsed).forEach(function(cat) {
        legendHtml += '<span class="graph-legend-item"><span class="graph-legend-dot" style="background:' + (CAT_COLORS[cat]||'var(--accent)') + '"></span>' + esc(cat) + '</span>';
      });
      safeRender('#graph-legend', legendHtml);

      if (graphAnim) cancelAnimationFrame(graphAnim);
      animateGraph(ctx, canvas);
      initGraphInteractions(canvas);
    });
  }).catch(function(e) {
    toast('Errore caricamento grafo: ' + e.message, 'error');
  });
}

function initGraphInteractions(canvas) {
  /* Evita doppi listener: rimuovi e ricrea */
  var newCanvas = canvas.cloneNode(true);
  canvas.parentNode.replaceChild(newCanvas, canvas);
  canvas = newCanvas;
  /* Aggiorna riferimento globale */
  var ctx = canvas.getContext('2d');
  ctx.scale(window.devicePixelRatio || 1, window.devicePixelRatio || 1);

  /* Riavvia animazione con nuovo canvas */
  if (graphAnim) cancelAnimationFrame(graphAnim);
  animateGraph(ctx, canvas);

  var tooltip = $('#graph-tooltip');

  /* ── Mouse move: hover + drag ─────────────────────────── */
  canvas.addEventListener('mousemove', function(e) {
    var g = screenToGraph(canvas, e.clientX, e.clientY);

    /* Drag di un nodo */
    if (graphState.dragNode) {
      graphState.dragNode.x = g.x;
      graphState.dragNode.y = g.y;
      graphState.dragNode.vx = 0;
      graphState.dragNode.vy = 0;
      return;
    }

    /* Pan della vista */
    if (graphState.isPanning && graphState.lastMouse) {
      var rect = canvas.getBoundingClientRect();
      var dx = (e.clientX - graphState.lastMouse.x) / graphState.zoom;
      var dy = (e.clientY - graphState.lastMouse.y) / graphState.zoom;
      graphState.panX += dx;
      graphState.panY += dy;
      graphState.lastMouse = { x: e.clientX, y: e.clientY };
      return;
    }

    /* Hover detection */
    var node = hitTestNode(g.x, g.y);
    graphState.hoveredNode = node;
    canvas.classList.toggle('hovering', !!node);

    if (node) {
      /* Mostra tooltip */
      var rect = canvas.getBoundingClientRect();
      var sx = (node.x - canvas.offsetWidth/2 + graphState.panX) * graphState.zoom + canvas.offsetWidth/2;
      var sy = (node.y - canvas.offsetHeight/2 + graphState.panY) * graphState.zoom + canvas.offsetHeight/2;
      tooltip.querySelector('.tt-id').textContent = '#' + node.id;
      var catBadge = tooltip.querySelector('.tt-cat');
      catBadge.textContent = node.category;
      catBadge.className = 'tt-cat badge badge-' + node.category;
      tooltip.querySelector('.tt-content').textContent = truncate(node.fullContent, 120);
      /* Relazioni del nodo */
      var rels = graphEdges.filter(function(ed) { return ed.source === node.id || ed.target === node.id; });
      if (rels.length) {
        tooltip.querySelector('.tt-relations').textContent = rels.length + ' relazion' + (rels.length === 1 ? 'e' : 'i');
      } else {
        tooltip.querySelector('.tt-relations').textContent = 'Nessuna relazione';
      }
      tooltip.style.left = Math.min(sx + 15, canvas.offsetWidth - 310) + 'px';
      tooltip.style.top = Math.min(sy - 10, canvas.offsetHeight - 80) + 'px';
      tooltip.classList.add('visible');
    } else {
      tooltip.classList.remove('visible');
    }
  });

  /* ── Mouse down: inizio drag nodo o pan ────────────── */
  canvas.addEventListener('mousedown', function(e) {
    var g = screenToGraph(canvas, e.clientX, e.clientY);
    var node = hitTestNode(g.x, g.y);
    if (node) {
      graphState.dragNode = node;
      canvas.classList.add('dragging');
    } else {
      graphState.isPanning = true;
      graphState.lastMouse = { x: e.clientX, y: e.clientY };
      canvas.classList.add('dragging');
    }
  });

  /* ── Mouse up: fine drag/pan ───────────────────────── */
  canvas.addEventListener('mouseup', function(e) {
    canvas.classList.remove('dragging');
    if (graphState.dragNode) {
      /* Dopo il drag, riavvia brevemente la simulazione per assestare */
      graphState.iteration = Math.min(graphState.iteration, 120);
    }
    graphState.dragNode = null;
    graphState.isPanning = false;
    graphState.lastMouse = null;
  });

  canvas.addEventListener('mouseleave', function() {
    canvas.classList.remove('dragging');
    canvas.classList.remove('hovering');
    graphState.dragNode = null;
    graphState.isPanning = false;
    graphState.lastMouse = null;
    tooltip.classList.remove('visible');
  });

  /* ── Click: seleziona nodo e mostra dettaglio ──────── */
  canvas.addEventListener('click', function(e) {
    var g = screenToGraph(canvas, e.clientX, e.clientY);
    var node = hitTestNode(g.x, g.y);
    if (node) {
      graphState.selectedNode = node;
      showGraphDetail(node);
    } else {
      graphState.selectedNode = null;
      $('#graph-detail').classList.remove('open');
    }
  });

  /* ── Wheel: zoom ───────────────────────────────────── */
  canvas.addEventListener('wheel', function(e) {
    e.preventDefault();
    var delta = e.deltaY > 0 ? 0.9 : 1.1;
    graphState.zoom = Math.max(0.2, Math.min(5, graphState.zoom * delta));
  }, { passive: false });
}

function showGraphDetail(node) {
  var detail = $('#graph-detail');
  /* Relazioni in uscita e in entrata */
  var outgoing = graphEdges.filter(function(e) { return e.source === node.id; });
  var incoming = graphEdges.filter(function(e) { return e.target === node.id; });

  var relsHtml = '';
  outgoing.forEach(function(e) {
    var target = graphNodes.find(function(n) { return n.id === e.target; });
    relsHtml += '<div style="padding:4px 0;font-size:12px"><span style="color:var(--accent)">\u2192</span> <span class="badge badge-tag">' + esc(e.label) + '</span> #' + e.target + (target ? ' <span style="color:var(--text-dim)">' + esc(truncate(target.fullContent, 30)) + '</span>' : '') + '</div>';
  });
  incoming.forEach(function(e) {
    var source = graphNodes.find(function(n) { return n.id === e.source; });
    relsHtml += '<div style="padding:4px 0;font-size:12px"><span style="color:var(--success)">\u2190</span> <span class="badge badge-tag">' + esc(e.label) + '</span> #' + e.source + (source ? ' <span style="color:var(--text-dim)">' + esc(truncate(source.fullContent, 30)) + '</span>' : '') + '</div>';
  });

  safeRender('#graph-detail-content',
    '<div style="margin-bottom:12px"><span style="font-family:var(--font-mono);color:var(--accent);font-weight:600">#' + node.id + '</span>' +
    ' <span class="badge badge-' + esc(node.category) + '">' + esc(node.category) + '</span></div>' +
    '<div style="font-size:13px;line-height:1.5;margin-bottom:12px">' + esc(node.fullContent) + '</div>' +
    '<div style="display:flex;gap:12px;margin-bottom:12px">' +
    '<div><span style="font-size:11px;color:var(--text-dim)">Importanza</span><div class="importance">' + importanceDots(node.importance) + '</div></div>' +
    '<div><span style="font-size:11px;color:var(--text-dim)">Decay</span><div style="display:flex;align-items:center;gap:4px;margin-top:2px"><div class="decay-bar" style="width:50px"><div class="decay-bar-fill" style="width:' + (node.decay_score*100).toFixed(0) + '%;background:' + decayColor(node.decay_score) + '"></div></div><span style="font-size:10px;color:var(--text-dim)">' + (node.decay_score*100).toFixed(0) + '%</span></div></div></div>' +
    '<div style="font-size:11px;color:var(--text-dim);margin-bottom:8px">' + fmtDate(node.created_at) + '</div>' +
    (relsHtml ? '<div class="card-title" style="font-size:11px;margin-bottom:4px">Relazioni (' + (outgoing.length + incoming.length) + ')</div>' + relsHtml : '<div style="font-size:12px;color:var(--text-dim)">Nessuna relazione</div>') +
    '<div style="margin-top:12px;display:flex;gap:6px">' +
    '<button class="btn btn-sm btn-primary" data-graph-edit="' + node.id + '">Modifica</button>' +
    '<button class="btn btn-sm btn-secondary" data-graph-goto="' + node.id + '">Vai a Memorie</button></div>'
  );

  detail.classList.add('open');

  /* Bottoni nel pannello dettaglio */
  var editBtn = detail.querySelector('[data-graph-edit]');
  if (editBtn) editBtn.addEventListener('click', function() {
    detail.classList.remove('open');
    navigate('memories');
    setTimeout(function() { openEditMemory(node.id); }, 300);
  });
  var gotoBtn = detail.querySelector('[data-graph-goto]');
  if (gotoBtn) gotoBtn.addEventListener('click', function() {
    detail.classList.remove('open');
    navigate('memories');
  });
}

function animateGraph(ctx, canvas) {
  var w = canvas.offsetWidth, h = canvas.offsetHeight;

  /* Simulazione forze — cooling progressivo e stabilizzazione */
  var cooling = graphState.iteration < 150 ? 1.0 : Math.max(0.0, 1.0 - (graphState.iteration - 150) / 150);
  graphState.iteration++;

  /* Se la simulazione si e' stabilizzata, non calcolare forze */
  if (cooling <= 0 && !graphState.dragNode) {
    /* Disegna e basta — nessuna forza applicata */
  } else {

  graphNodes.forEach(function(n) {
    if (n === graphState.dragNode) return;
    n.vx *= 0.8; n.vy *= 0.8;
    /* Gravita' verso il centro — forte abbastanza da vincere la repulsione */
    n.vx += (w/2 - n.x) * 0.005 * cooling;
    n.vy += (h/2 - n.y) * 0.005 * cooling;
  });

  /* Repulsione tra nodi — forza piu' contenuta con distanza minima */
  for (var i = 0; i < graphNodes.length; i++) {
    for (var j = i + 1; j < graphNodes.length; j++) {
      var a = graphNodes[i], b = graphNodes[j];
      if (a === graphState.dragNode || b === graphState.dragNode) continue;
      var dx = b.x - a.x, dy = b.y - a.y;
      var dist = Math.sqrt(dx*dx + dy*dy) || 1;
      if (dist > 300) continue; /* Ignora nodi troppo distanti */
      var force = 400 * cooling / (dist * dist + 100);
      a.vx -= dx * force; a.vy -= dy * force;
      b.vx += dx * force; b.vy += dy * force;
    }
  }

  /* Attrazione archi — spring ideale a 100px */
  graphEdges.forEach(function(e) {
    var a = graphNodes.find(function(n) { return n.id === e.source; });
    var b = graphNodes.find(function(n) { return n.id === e.target; });
    if (!a || !b) return;
    if (a === graphState.dragNode || b === graphState.dragNode) return;
    var dx = b.x - a.x, dy = b.y - a.y;
    var dist = Math.sqrt(dx*dx + dy*dy) || 1;
    var f = (dist - 100) * 0.01 * cooling;
    a.vx += dx/dist * f; a.vy += dy/dist * f;
    b.vx -= dx/dist * f; b.vy -= dy/dist * f;
  });

  /* Aggiorna posizioni con margine del 15% dal bordo */
  var mx = w * 0.15, my = h * 0.15;
  graphNodes.forEach(function(n) {
    if (n === graphState.dragNode) return;
    n.x += n.vx * 0.3;
    n.y += n.vy * 0.3;
    n.x = Math.max(mx, Math.min(w - mx, n.x));
    n.y = Math.max(my, Math.min(h - my, n.y));
  });

  } /* fine blocco cooling > 0 */

  /* ── Disegno ────────────────────────────────────── */
  var isDark = state.theme === 'dark';
  ctx.clearRect(0, 0, w, h);
  ctx.save();

  /* Applica zoom e pan */
  ctx.translate(w/2, h/2);
  ctx.scale(graphState.zoom, graphState.zoom);
  ctx.translate(graphState.panX - w/2, graphState.panY - h/2);

  /* Archi */
  graphEdges.forEach(function(e) {
    var a = graphNodes.find(function(n) { return n.id === e.source; });
    var b = graphNodes.find(function(n) { return n.id === e.target; });
    if (!a || !b) return;

    var isHighlighted = graphState.hoveredNode && (graphState.hoveredNode.id === a.id || graphState.hoveredNode.id === b.id);
    var isSelected = graphState.selectedNode && (graphState.selectedNode.id === a.id || graphState.selectedNode.id === b.id);

    ctx.strokeStyle = isHighlighted || isSelected
      ? (isDark ? 'rgba(139,92,246,0.7)' : 'rgba(124,58,237,0.5)')
      : (isDark ? 'rgba(139,92,246,0.15)' : 'rgba(124,58,237,0.1)');
    ctx.lineWidth = isHighlighted || isSelected ? 2 : 1;

    ctx.beginPath();
    ctx.moveTo(a.x, a.y);
    ctx.lineTo(b.x, b.y);
    ctx.stroke();

    /* Freccia direzionale */
    if (graphState.showArrows) {
      var dx = b.x - a.x, dy = b.y - a.y;
      var dist = Math.sqrt(dx*dx + dy*dy) || 1;
      var rB = 6 + b.importance * 2.5;
      var ax = b.x - (dx/dist) * (rB + 4);
      var ay = b.y - (dy/dist) * (rB + 4);
      var angle = Math.atan2(dy, dx);
      var arrowLen = 8;
      ctx.fillStyle = ctx.strokeStyle;
      ctx.beginPath();
      ctx.moveTo(ax, ay);
      ctx.lineTo(ax - arrowLen * Math.cos(angle - 0.35), ay - arrowLen * Math.sin(angle - 0.35));
      ctx.lineTo(ax - arrowLen * Math.cos(angle + 0.35), ay - arrowLen * Math.sin(angle + 0.35));
      ctx.closePath();
      ctx.fill();
    }

    /* Label relazione al centro dell'arco */
    if (graphState.showLabels && (isHighlighted || isSelected)) {
      var mx = (a.x + b.x) / 2, my = (a.y + b.y) / 2;
      ctx.fillStyle = isDark ? 'rgba(139,92,246,0.9)' : 'rgba(124,58,237,0.8)';
      ctx.font = '9px system-ui';
      ctx.textAlign = 'center';
      ctx.fillText(e.label, mx, my - 4);
    }
  });

  /* Nodi */
  graphNodes.forEach(function(n) {
    var r = 6 + n.importance * 2.5;
    var isHovered = graphState.hoveredNode === n;
    var isSelected = graphState.selectedNode === n;
    var isConnected = false;
    if (graphState.hoveredNode && graphState.hoveredNode !== n) {
      isConnected = graphEdges.some(function(e) {
        return (e.source === graphState.hoveredNode.id && e.target === n.id) ||
               (e.target === graphState.hoveredNode.id && e.source === n.id);
      });
    }

    var baseColor = CAT_COLORS[n.category] || '#8b5cf6';
    var dimmed = graphState.hoveredNode && !isHovered && !isConnected;

    /* Glow per nodo selezionato/hover */
    if (isSelected || isHovered) {
      ctx.beginPath();
      ctx.arc(n.x, n.y, r + 6, 0, Math.PI * 2);
      ctx.fillStyle = baseColor.replace(')', ',0.2)').replace('rgb', 'rgba');
      if (baseColor.charAt(0) === '#') {
        ctx.fillStyle = baseColor + '33';
      }
      ctx.fill();
    }

    /* Cerchio nodo */
    ctx.beginPath();
    ctx.arc(n.x, n.y, r, 0, Math.PI * 2);
    ctx.fillStyle = dimmed ? (isDark ? '#3f3f46' : '#d4d4d8') : baseColor;
    ctx.fill();

    /* Bordo per nodo selezionato */
    if (isSelected) {
      ctx.strokeStyle = '#fff';
      ctx.lineWidth = 2;
      ctx.stroke();
    }

    /* Label sotto il nodo */
    if (graphState.showLabels && !dimmed) {
      ctx.fillStyle = isHovered || isSelected
        ? (isDark ? '#fafafa' : '#18181b')
        : (isDark ? '#71717a' : '#a1a1aa');
      ctx.font = (isHovered || isSelected ? 'bold ' : '') + '10px system-ui';
      ctx.textAlign = 'center';
      ctx.fillText('#' + n.id + ' ' + n.label, n.x, n.y + r + 14);
    }
  });

  ctx.restore();
  graphAnim = requestAnimationFrame(function() { animateGraph(ctx, canvas); });
}

/* ═══════════════════════════════════════════════════════════════════════
   PAGINA: Sessions
   ═══════════════════════════════════════════════════════════════════════ */
function loadSessions() {
  var list = $('#sessions-list');
  safeRender(list, '<div class="loading-center"><div class="spinner"></div></div>');

  api.get('/sessions?limit=50').then(function(sessions) {
    if (!sessions || !sessions.length) {
      safeRender(list, '<div class="empty-state"><p>Nessuna sessione trovata</p></div>');
      return;
    }
    var html = '';
    sessions.forEach(function(s) {
      html += '<div class="session-card"><div class="session-info">' +
        '<h4>' + esc(s.title || s.id) + '</h4>' +
        '<div class="meta">' + esc(s.id) + ' \u2014 ' + fmtDate(s.created_at) +
        (s.ended_at ? ' \u2192 ' + fmtDate(s.ended_at) : ' <span style="color:var(--success)">\u2022 attiva</span>') +
        '</div></div><div style="display:flex;gap:6px">' +
        (!s.ended_at ? '<button class="btn btn-sm btn-secondary" data-end-session="' + esc(s.id) + '">Termina</button>' : '') +
        '<button class="btn btn-sm btn-secondary" data-view-session="' + esc(s.id) + '">Memorie</button>' +
        '<button class="btn btn-sm btn-danger" data-del-session="' + esc(s.id) + '">Elimina</button>' +
        '</div></div>';
    });
    safeRender(list, html);

    list.querySelectorAll('[data-end-session]').forEach(function(btn) {
      btn.addEventListener('click', function() {
        api.post('/sessions/' + encodeURIComponent(btn.dataset.endSession) + '/end').then(function() {
          toast('Sessione terminata', 'success'); loadSessions();
        }).catch(function(e) { toast(e.message, 'error'); });
      });
    });
    list.querySelectorAll('[data-del-session]').forEach(function(btn) {
      btn.addEventListener('click', function() {
        if (!confirm('Eliminare questa sessione?')) return;
        api.del('/sessions/' + encodeURIComponent(btn.dataset.delSession)).then(function() {
          toast('Sessione eliminata', 'success'); loadSessions();
        }).catch(function(e) { toast(e.message, 'error'); });
      });
    });
    list.querySelectorAll('[data-view-session]').forEach(function(btn) {
      btn.addEventListener('click', function() {
        api.get('/sessions/' + encodeURIComponent(btn.dataset.viewSession) + '/memories').then(function(res) {
          var mems = res.results || [];
          if (!mems.length) { toast('Nessuna memoria in questa sessione', 'info'); return; }
          var h = '<div class="card" style="margin-top:16px"><div class="card-title">Memorie sessione ' + esc(btn.dataset.viewSession) + '</div>';
          mems.forEach(function(m) {
            h += '<div style="padding:8px 0;border-bottom:1px solid var(--border)"><span class="badge badge-' + esc(m.category) + '" style="margin-right:6px">' + esc(m.category) + '</span><span style="font-size:13px">' + esc(truncate(m.content, 120)) + '</span></div>';
          });
          h += '</div>';
          list.insertAdjacentHTML('beforeend', h);
        }).catch(function(e) { toast(e.message, 'error'); });
      });
    });
  }).catch(function(e) {
    safeRender(list, '<div class="empty-state"><p>Errore: ' + esc(e.message) + '</p></div>');
  });
}

/* ═══════════════════════════════════════════════════════════════════════
   PAGINA: Timeline
   ═══════════════════════════════════════════════════════════════════════ */
function loadTimeline(subject) {
  if (!subject) {
    safeRender('#timeline-list', '<div class="empty-state"><p>Inserisci un soggetto da cercare nella timeline</p></div>');
    return;
  }
  safeRender('#timeline-list', '<div class="loading-center"><div class="spinner"></div></div>');

  api.get('/timeline?subject=' + encodeURIComponent(subject) + '&limit=30').then(function(data) {
    if (!data.results || !data.results.length) {
      safeRender('#timeline-list', '<div class="empty-state"><p>Nessun risultato trovato</p></div>');
      return;
    }
    var html = '';
    data.results.forEach(function(m) {
      html += '<div class="timeline-item">' +
        '<div class="timeline-dot" style="background:' + (CAT_COLORS[m.category]||'var(--accent)') + '"></div>' +
        '<div class="timeline-content"><div class="timeline-date">' + fmtDate(m.created_at) +
        ' \u2014 <span class="badge badge-' + esc(m.category) + '">' + esc(m.category) + '</span></div>' +
        '<div class="timeline-text">' + esc(m.content) + '</div></div></div>';
    });
    safeRender('#timeline-list', html);
  }).catch(function(e) {
    safeRender('#timeline-list', '<div class="empty-state"><p>Errore: ' + esc(e.message) + '</p></div>');
  });
}

/* ═══════════════════════════════════════════════════════════════════════
   PAGINA: Maintenance
   ═══════════════════════════════════════════════════════════════════════ */
function loadMaintenance() {
  /* Scoring stats */
  api.get('/stats/scoring').then(function(stats) {
    var dist = stats.distribution || {};
    var h = '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px">' +
      '<div><span style="color:var(--text-dim);font-size:12px">Totale</span><div style="font-size:20px;font-weight:600">' + stats.total + '</div></div>' +
      '<div><span style="color:var(--text-dim);font-size:12px">Imp. media</span><div style="font-size:20px;font-weight:600">' + (stats.avg_importance || 0).toFixed(1) + '</div></div>' +
      '<div><span style="color:var(--text-dim);font-size:12px">Mai accesso (30gg)</span><div style="font-size:20px;font-weight:600;color:var(--warning)">' + stats.never_accessed_30d + '</div></div>' +
      '<div><span style="color:var(--text-dim);font-size:12px">Accesso frequente</span><div style="font-size:20px;font-weight:600;color:var(--success)">' + stats.frequently_accessed + '</div></div></div>' +
      '<div class="card-title" style="margin-top:8px">Distribuzione importanza</div>';
    [1,2,3,4,5].forEach(function(i) {
      var count = dist[String(i)] || 0;
      var pct = stats.total ? (count / stats.total * 100).toFixed(0) : 0;
      h += '<div class="cat-bar-row"><span class="cat-bar-label">' + '\u2605'.repeat(i) + '</span><div class="cat-bar-track"><div class="cat-bar-fill" style="width:' + pct + '%;background:var(--accent)"></div></div><span class="cat-bar-count">' + count + '</span></div>';
    });
    safeRender('#scoring-stats', h);
  }).catch(function() {
    safeRender('#scoring-stats', '<div class="empty-state"><p>Stats non disponibili</p></div>');
  });

  /* Archivio */
  api.get('/archive?limit=20').then(function(arch) {
    var items = arch.results || [];
    if (items.length) {
      var h = '';
      items.forEach(function(m) {
        h += '<div style="padding:8px 0;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center">' +
          '<div><span style="font-size:12px;color:var(--text-dim)">#' + m.id + '</span> <span style="font-size:13px">' + esc(truncate(m.content, 60)) + '</span></div>' +
          '<button class="btn btn-sm btn-success" data-restore="' + m.id + '">Ripristina</button></div>';
      });
      safeRender('#archive-list', h);
      $('#archive-list').querySelectorAll('[data-restore]').forEach(function(btn) {
        btn.addEventListener('click', function() {
          api.post('/memories/' + btn.dataset.restore + '/restore').then(function() {
            toast('Memoria ripristinata', 'success'); loadMaintenance();
          }).catch(function(e) { toast(e.message, 'error'); });
        });
      });
    } else {
      safeRender('#archive-list', '<div class="empty-state" style="padding:24px"><p>Nessuna memoria archiviata</p></div>');
    }
  }).catch(function() {
    safeRender('#archive-list', '<div class="empty-state"><p>Errore caricamento archivio</p></div>');
  });
}

function runMaintenanceAction(action) {
  var endpoints = { decay: '/decay/run', compress: '/compress', cleanup: '/cleanup', autotune: '/auto-tune' };
  api.post(endpoints[action]).then(function(result) {
    switch (action) {
      case 'decay': toast('Decay completato: ' + result.updated + ' memorie aggiornate', 'success'); break;
      case 'compress': toast('Compressione: ' + result.clusters_found + ' cluster, ' + result.memories_merged + ' unite', 'success'); break;
      case 'cleanup': toast('Cleanup: ' + result.removed + ' memorie scadute rimosse', 'success'); break;
      case 'autotune': toast('Auto-tune: ' + result.boosted + ' potenziate, ' + result.reduced + ' ridotte', 'success'); break;
    }
  }).catch(function(e) { toast('Errore: ' + e.message, 'error'); });
}

/* ═══════════════════════════════════════════════════════════════════════
   PAGINA: Settings
   ═══════════════════════════════════════════════════════════════════════ */
function loadSettings() {
  /* Agenti */
  api.get('/agents').then(function(agents) {
    if (agents && agents.length) {
      var h = '<table><thead><tr><th>Agent ID</th><th>Memorie</th><th>Ultima attivit\u00e0</th></tr></thead><tbody>';
      agents.forEach(function(a) {
        h += '<tr><td style="font-family:var(--font-mono);color:var(--accent)">' + esc(a.agent_id) + '</td>' +
          '<td>' + a.memory_count + '</td><td style="color:var(--text-dim)">' + fmtDate(a.last_activity) + '</td></tr>';
      });
      h += '</tbody></table>';
      safeRender('#agents-list', h);
    } else {
      safeRender('#agents-list', '<div class="empty-state"><p>Nessun agente trovato</p></div>');
    }
  }).catch(function() {
    safeRender('#agents-list', '<div class="empty-state"><p>Errore</p></div>');
  });

  /* Server info */
  api.get('/health').then(function(health) {
    safeRender('#server-info',
      '<div style="display:grid;gap:8px">' +
      '<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)"><span style="color:var(--text-dim)">Stato</span><span style="color:var(--success);font-weight:500">' + esc(health.status) + '</span></div>' +
      '<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)"><span style="color:var(--text-dim)">Versione</span><span>' + esc(health.version) + '</span></div>' +
      '<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)"><span style="color:var(--text-dim)">Ricerca semantica</span><span style="color:' + (health.semantic_search ? 'var(--success)' : 'var(--text-dim)') + '">' + (health.semantic_search ? 'Attiva' : 'Disattiva') + '</span></div></div>'
    );
  }).catch(function() {
    safeRender('#server-info', '<div class="empty-state"><p>Server non raggiungibile</p></div>');
  });

  loadAuditLog();

  /* Metriche */
  api.get('/metrics').then(function(metrics) {
    $('#metrics-display').textContent = typeof metrics === 'string' ? metrics : JSON.stringify(metrics, null, 2);
  }).catch(function() {
    $('#metrics-display').textContent = 'Metriche non disponibili';
  });
}

function loadAuditLog() {
  var eventFilter = $('#audit-event-filter') ? $('#audit-event-filter').value : '';
  var url = '/audit?limit=100';
  if (eventFilter) url += '&event=' + encodeURIComponent(eventFilter);

  api.get(url).then(function(data) {
    var events = data.events || [];
    if (events.length) {
      var h = '<table><thead><tr><th>Evento</th><th>Memoria</th><th>Data</th><th>Dati</th></tr></thead><tbody>';
      events.slice(0, 50).forEach(function(e) {
        h += '<tr class="audit-row"><td><span class="audit-event">' + esc(e.event) + '</span></td>' +
          '<td>' + (e.memory_id ? '#' + e.memory_id : '\u2014') + '</td>' +
          '<td class="audit-time">' + fmtDate(e.created_at) + '</td>' +
          '<td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="' + esc(e.data || '') + '">' + esc(truncate(e.data || '', 40)) + '</td></tr>';
      });
      h += '</tbody></table>';
      safeRender('#audit-table', h);
    } else {
      safeRender('#audit-table', '<div class="empty-state" style="padding:24px"><p>Nessun evento audit</p></div>');
    }
  }).catch(function() {
    safeRender('#audit-table', '<div class="empty-state"><p>Audit log non disponibile (KORE_AUDIT_LOG=1)</p></div>');
  });
}

/* ═══════════════════════════════════════════════════════════════════════
   Event Handlers
   ═══════════════════════════════════════════════════════════════════════ */
function initEventHandlers() {
  $('#btn-theme').addEventListener('click', function() {
    state.theme = state.theme === 'dark' ? 'light' : 'dark';
    localStorage.setItem('kore-theme', state.theme);
    applyTheme();
  });

  $('#btn-hamburger').addEventListener('click', function() {
    $('#sidebar').classList.toggle('open');
  });

  $('#mem-search').addEventListener('input', function() {
    clearTimeout(memSearchTimeout);
    memSearchTimeout = setTimeout(function() { loadMemories(); }, 400);
  });
  $('#mem-search').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') { clearTimeout(memSearchTimeout); loadMemories(); }
  });
  $('#mem-category').addEventListener('change', function() { loadMemories(); });
  $('#mem-semantic').addEventListener('change', function() { loadMemories(); });

  $('#btn-new-memory').addEventListener('click', function() {
    state.editingMemoryId = null;
    $('#modal-memory-title').textContent = 'Nuova memoria';
    $('#modal-mem-content').value = '';
    $('#modal-mem-category').value = 'general';
    $('#modal-mem-importance').value = '1';
    $('#modal-mem-ttl').value = '';
    $('#modal-mem-tags').value = '';
    $('#modal-memory').classList.add('open');
  });

  $('#modal-memory-close').addEventListener('click', function() { $('#modal-memory').classList.remove('open'); });
  $('#modal-mem-cancel').addEventListener('click', function() { $('#modal-memory').classList.remove('open'); });

  $('#modal-mem-save').addEventListener('click', function() {
    var content = $('#modal-mem-content').value.trim();
    if (!content) { toast('Il contenuto \u00e8 obbligatorio', 'error'); return; }
    var category = $('#modal-mem-category').value;
    var importance = parseInt($('#modal-mem-importance').value);
    var ttl = $('#modal-mem-ttl').value ? parseInt($('#modal-mem-ttl').value) : null;
    var tags = $('#modal-mem-tags').value.split(',').map(function(t) { return t.trim(); }).filter(Boolean);

    if (state.editingMemoryId) {
      api.put('/memories/' + state.editingMemoryId, { content: content, category: category, importance: importance }).then(function() {
        toast('Memoria aggiornata', 'success');
        $('#modal-memory').classList.remove('open');
        loadMemories();
      }).catch(function(e) { toast(e.message, 'error'); });
    } else {
      var body = { content: content, category: category, importance: importance };
      if (ttl) body.ttl_hours = ttl;
      api.post('/save', body).then(function(res) {
        if (tags.length && res && res.id) {
          return api.post('/memories/' + res.id + '/tags', { tags: tags });
        }
      }).then(function() {
        toast('Memoria salvata', 'success');
        $('#modal-memory').classList.remove('open');
        loadMemories();
      }).catch(function(e) { toast(e.message, 'error'); });
    }
  });

  $('#btn-new-session').addEventListener('click', function() {
    $('#modal-sess-id').value = 'session-' + new Date().toISOString().slice(0, 10) + '-' + Math.random().toString(36).slice(2, 6);
    $('#modal-sess-title').value = '';
    $('#modal-session').classList.add('open');
  });
  $('#modal-session-close').addEventListener('click', function() { $('#modal-session').classList.remove('open'); });
  $('#modal-sess-cancel').addEventListener('click', function() { $('#modal-session').classList.remove('open'); });
  $('#modal-sess-save').addEventListener('click', function() {
    var id = $('#modal-sess-id').value.trim();
    if (!id) { toast('Session ID obbligatorio', 'error'); return; }
    api.post('/sessions', { session_id: id, title: $('#modal-sess-title').value.trim() || null }).then(function() {
      toast('Sessione creata', 'success');
      $('#modal-session').classList.remove('open');
      loadSessions();
    }).catch(function(e) { toast(e.message, 'error'); });
  });

  $('#btn-timeline-search').addEventListener('click', function() { loadTimeline($('#timeline-search').value.trim()); });
  $('#timeline-search').addEventListener('keydown', function(e) { if (e.key === 'Enter') loadTimeline($('#timeline-search').value.trim()); });

  $('#btn-decay').addEventListener('click', function() { runMaintenanceAction('decay'); });
  $('#btn-compress').addEventListener('click', function() { runMaintenanceAction('compress'); });
  $('#btn-cleanup').addEventListener('click', function() { runMaintenanceAction('cleanup'); });
  $('#btn-autotune').addEventListener('click', function() { runMaintenanceAction('autotune'); });

  $('#btn-export').addEventListener('click', function() {
    api.get('/export').then(function(data) {
      var blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      var url = URL.createObjectURL(blob);
      var a = document.createElement('a');
      a.href = url; a.download = 'kore-export-' + state.agentId + '-' + new Date().toISOString().slice(0,10) + '.json';
      a.click(); URL.revokeObjectURL(url);
      toast('Export completato: ' + data.total + ' memorie', 'success');
    }).catch(function(e) { toast(e.message, 'error'); });
  });

  $('#import-file').addEventListener('change', function(e) {
    var file = e.target.files[0];
    if (!file) return;
    file.text().then(function(text) {
      var data = JSON.parse(text);
      var memories = data.memories || data;
      if (!Array.isArray(memories)) throw new Error('Formato non valido');
      return api.post('/import', { memories: memories });
    }).then(function(res) {
      toast('Import: ' + res.imported + ' memorie importate', 'success');
      e.target.value = '';
    }).catch(function(err) { toast('Errore import: ' + err.message, 'error'); });
  });

  $('#btn-add-relation').addEventListener('click', function() {
    var source = parseInt($('#rel-source').value);
    var target = parseInt($('#rel-target').value);
    var relation = $('#rel-type').value.trim() || 'related';
    if (!source || !target) { toast('Inserisci ID sorgente e target', 'error'); return; }
    api.post('/memories/' + source + '/relations', { target_id: target, relation: relation }).then(function() {
      toast('Relazione creata', 'success'); loadTags();
    }).catch(function(e) { toast(e.message, 'error'); });
  });

  $('#btn-graph-reload').addEventListener('click', loadGraph);
  $('#btn-graph-center').addEventListener('click', function() {
    graphState.zoom = 1; graphState.panX = 0; graphState.panY = 0;
  });
  $('#graph-show-labels').addEventListener('change', function(e) {
    graphState.showLabels = e.target.checked;
  });
  $('#graph-show-arrows').addEventListener('change', function(e) {
    graphState.showArrows = e.target.checked;
  });
  $('#graph-detail-close').addEventListener('click', function() {
    graphState.selectedNode = null;
    $('#graph-detail').style.display = 'none';
  });

  $('#agent-select').addEventListener('change', function(e) {
    state.agentId = e.target.value;
    loadPageData(state.currentPage);
  });

  $('#btn-audit-refresh').addEventListener('click', loadAuditLog);
  $('#audit-event-filter').addEventListener('change', loadAuditLog);

  /* Chiudi modal con click su overlay */
  $$('.modal-overlay').forEach(function(overlay) {
    overlay.addEventListener('click', function(e) {
      if (e.target === overlay) overlay.classList.remove('open');
    });
  });

  /* Chiudi modal con Escape */
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      $$('.modal-overlay.open').forEach(function(m) { m.classList.remove('open'); });
    }
  });

  /* Filtro tag */
  $('#tag-search').addEventListener('input', function() {
    var q = $('#tag-search').value.toLowerCase();
    $$('#tag-cloud .badge-tag').forEach(function(el) {
      el.style.display = el.textContent.toLowerCase().indexOf(q) >= 0 ? '' : 'none';
    });
  });
}

/* ── Carica lista agenti nel selettore ─────────────────────────────── */
function loadAgentSelector() {
  api.get('/agents').then(function(agents) {
    var select = $('#agent-select');
    var current = select.value;
    var html = '';
    (agents || []).forEach(function(a) {
      html += '<option value="' + esc(a.agent_id) + '">' + esc(a.agent_id) + ' (' + a.memory_count + ')</option>';
    });
    safeRender(select, html);
    if (!select.querySelector('option[value="' + current + '"]')) {
      select.insertAdjacentHTML('afterbegin', '<option value="default">default</option>');
    }
    select.value = current || 'default';
  }).catch(function() { /* mantieni default */ });
}

/* ── Inizializzazione ──────────────────────────────────────────────── */
function init() {
  applyTheme();
  initNav();
  initEventHandlers();
  loadAgentSelector();
  loadPageData('overview');
}

init();
</script>
</body>
</html>
