# Kore Memory — Roadmap v1.0 "Stable Release"

> Generato: 2026-02-25 | Versione attuale: 0.9.0 | Target: 1.0.0
> Analisi eseguita da: Security Audit, Code Review, Architecture Analysis, Context7 Verification, Test Coverage Analysis

## Score attuale: 7.5/10

---

## Fase 1 — Bug critici (BLOCKING)

Devono essere risolti prima di qualsiasi altro lavoro.

### 1.1 Ordine parametri SQL in `_semantic_search`
- **File**: `kore_memory/repository.py:902-926`
- **Bug**: Quando `cursor + category` sono entrambi forniti, i parametri SQL vengono passati nell'ordine errato. La query SQL posiziona `{category_clause}` prima di `{cursor_filter}`, ma i parametri vengono accumulati nell'ordine inverso.
- **Impatto**: Risultati di ricerca semantica completamente sbagliati con cursor+category
- **Fix**: Invertire l'ordine di accumulo: prima `category`, poi `cursor`
- **Stato**: [x] Completato (2026-02-25) — ordine corretto: IN ids, category, cursor

### 1.2 Memorie archiviate visibili nei risultati di search
- **File**: `kore_memory/repository.py:803-876, 879-944` e `kore_memory/vector_index.py:119-137`
- **Bug**: `_fts_search`, `_semantic_search` e `VectorIndex._reload_from_db` non filtrano `archived_at IS NOT NULL`
- **Impatto**: Le memorie archiviate (soft-deleted) appaiono nei risultati normali
- **Fix**: Aggiungere `AND archived_at IS NULL` nelle clausole WHERE di:
  - `_fts_search` (riga ~827)
  - `_semantic_search` DB query (riga ~919)
  - `_reload_from_db` (riga ~124)
- **Stato**: [x] Completato (2026-02-25) — aggiunto `AND archived_at IS NULL` in _fts_search, _semantic_search, _reload_from_db

### 1.3 Compressor include memorie archiviate
- **File**: `kore_memory/compressor.py:81-90`
- **Bug**: `_load_compressible_memories` non filtra `archived_at IS NOT NULL`
- **Impatto**: Memoria archiviata puo' tornare "attiva" dopo compressione
- **Fix**: Aggiungere `AND archived_at IS NULL` nella query
- **Stato**: [x] Completato (2026-02-25) — aggiunto `AND archived_at IS NULL` nel compressor

### 1.4 Decay pass include memorie archiviate
- **File**: `kore_memory/repository.py:319`
- **Bug**: Il decay pass aggiorna `decay_score` anche per record archiviati
- **Fix**: Aggiungere `AND archived_at IS NULL` nella query SELECT
- **Stato**: [x] Completato (2026-02-25) — aggiunto `AND archived_at IS NULL` nel decay pass

---

## Fase 2 — Sicurezza (BLOCKING)

Vulnerabilita' che vanno risolte prima del rilascio pubblico.

### 2.1 Auth bypass via "testclient" in host trusted
- **File**: `kore_memory/auth.py:62`
- **Severita'**: CRITICA
- **Bug**: `"testclient"` nella lista degli host locali trusted in produzione
- **Fix**: Spostare dietro env `KORE_TEST_MODE=1`, usare `os.getenv("KORE_TEST_MODE", "0") == "1"`
- **Stato**: [x] Completato (2026-02-25) — `KORE_TEST_MODE` env var + conftest.py

### 2.2 `/metrics` senza autenticazione
- **File**: `kore_memory/main.py:647-666`
- **Severita'**: ALTA
- **Bug**: Endpoint accessibile senza `_Auth` dependency, espone stats di tutti gli agenti
- **Fix**: Aggiungere `_: str = _Auth` e `agent_id: str = _Agent` come dependency
- **Stato**: [x] Completato (2026-02-25) — aggiunto `_Auth` + `_Agent` dependency

### 2.3 Rate limiting mancante su endpoint distruttivi
- **File**: `kore_memory/config.py:33-39`
- **Severita'**: ALTA
- **Endpoint senza rate limit**: DELETE /memories, GET /export, POST /import, POST /cleanup, DELETE /sessions
- **Fix**: Aggiungere limiti in `RATE_LIMITS` dict
- **Stato**: [x] Completato (2026-02-25) — aggiunto export, import, cleanup, delete

### 2.4 `X-Session-Id` non validato
- **File**: `kore_memory/main.py:222`
- **Severita'**: MEDIA
- **Bug**: Header letto senza sanitizzazione, accetta caratteri speciali e lunghezza arbitraria
- **Fix**: Regex `^[a-zA-Z0-9_-]{1,128}$` prima di usare il valore
- **Stato**: [x] Completato (2026-02-25) — regex `_SESSION_ID_RE` + `_validate_session_id()`

### 2.5 MCP `agent_id` non sanitizzato
- **File**: `kore_memory/mcp_server.py:43-57`
- **Severita'**: MEDIA
- **Bug**: Il server MCP bypassa la sanitizzazione di `auth.get_agent_id()`
- **Fix**: Aggiungere `_sanitize_agent_id()` che applica stessa regex di auth.py
- **Stato**: [x] Completato (2026-02-25) — `_sanitize_agent_id()` applicato a tutti i 14 tool MCP

### 2.6 `X-XSS-Protection` obsoleto
- **File**: `kore_memory/main.py:150`
- **Severita'**: BASSA
- **Fix**: Cambiare da `"1; mode=block"` a `"0"`
- **Stato**: [x] Completato (2026-02-25) — cambiato a `"0"`

### 2.7 API key log masking troppo rivelatorio
- **File**: `kore_memory/auth.py:41`
- **Severita'**: BASSA
- **Fix**: Mostrare solo i primi 4 caratteri invece di 8+8
- **Stato**: [x] Completato (2026-02-25) — mostra solo 4 char + asterischi

---

## Fase 3 — Architettura e coerenza (BLOCKING)

### 3.1 Colonne `archived_at` e `session_id` nel CREATE TABLE
- **File**: `kore_memory/database.py:95-113`
- **Problema**: Colonne aggiunte solo via migration runtime, non nello schema principale
- **Fix**: Aggiungere al `CREATE TABLE IF NOT EXISTS memories`
- **Stato**: [x] Completato (2026-02-25) — colonne aggiunte nello schema + indice `idx_memories_archived`

### 3.2 Graceful shutdown
- **File**: `kore_memory/main.py` (lifespan)
- **Problema**: Pool SQLite non chiuso su SIGTERM/SIGINT — rischio corruzione WAL
- **Fix**: Aggiungere `_pool.clear()` nel lifespan FastAPI dopo yield
- **Stato**: [x] Completato (2026-02-25) — `_pool.clear()` nel lifespan yield

### 3.3 Health check con verifica DB
- **File**: `kore_memory/main.py`
- **Problema**: `/health` non verifica connettivita' DB (sempre "ok" anche con DB corrotto)
- **Fix**: Aggiungere `SELECT 1` nel health check, restituire `"degraded"` se fallisce
- **Stato**: [x] Completato (2026-02-25) — `SELECT 1` + status `"degraded"` + campo `database`

### 3.4 Response model Pydantic per tutti gli endpoint
- **File**: `kore_memory/main.py`, `kore_memory/models.py`
- **Endpoint corretti**: archive, restore, sessions (create/list/end/delete), entities, agents, audit
- **Nuovi modelli**: `SessionDeleteResponse`, `EntityRecord`, `EntityListResponse`, `AgentRecord`, `AgentListResponse`, `AuditEventRecord`, `AuditResponse`
- **Stato**: [x] Completato (2026-02-25) — 9 endpoint con response_model, 7 nuovi modelli

### 3.5 `save_memory_batch` non emette eventi audit
- **File**: `kore_memory/repository.py`
- **Fix**: Aggiunto `emit(MEMORY_SAVED, ...)` per ogni memoria salvata nel batch
- **Stato**: [x] Completato (2026-02-25) — emit dopo ciclo insert

### 3.6 `update_memory` risponde con `importance=0` invalido
- **File**: `kore_memory/main.py`
- **Bug**: `MemorySaveResponse(importance=req.importance or 0)` — se importance non aggiornato, ritorna 0
- **Fix**: SELECT importance reale dal DB dopo update
- **Stato**: [x] Completato (2026-02-25) — query DB per importance reale

### 3.7 `auto_score` impossibile salvare importance=1 esplicita
- **File**: `kore_memory/models.py`, `kore_memory/repository.py`, `kore_memory/mcp_server.py`
- **Problema**: `if importance == 1` attiva auto-scoring anche per valore esplicito
- **Fix**: `importance: int | None = None` nel modello, `if importance is None:` nel repository
- **Stato**: [x] Completato (2026-02-25) — sentinel `None`, MCP aggiornato

---

## Fase 4 — Test coverage (IMPORTANTE)

Coverage attuale: 81% globale. Target v1.0: >= 85%.

### 4.1 Test mancanti — Priorita' 1 (funzionalita' core)

| Test da aggiungere | File target | Modulo testato |
|---|---|---|
| `TestArchive` (archive, restore, get_archived) | test_api.py | repository.py, main.py |
| `TestCursorPagination` (cursor valido, invalido, has_more) | test_api.py | main.py, repository.py |
| `TestRateLimit` (superamento, 429, cleanup bucket) | test_api.py | main.py |
| `TestKoreClientSync` (tutti i metodi sincroni) | test_client_sync.py (nuovo) | client.py |

### 4.2 Test mancanti — Priorita' 2

| Test da aggiungere | File target | Modulo testato |
|---|---|---|
| `TestCLI` (argomenti, uvicorn non trovato) | test_cli.py (nuovo) | cli.py |
| `TestAuthAutoGeneration` (API key creation) | test_api.py | auth.py |
| `TestCompressorPython` (fallback senza numpy) | test_api.py | compressor.py |
| `TestAgentsEndpoint` e `TestMetricsEndpoint` | test_api.py | main.py |

### 4.3 Test mancanti — Priorita' 3

- `database.py`: connessione corrotta nel pool, rollback su eccezione
- `repository.py`: wildcard `q=*`, cursor semantico + category, update senza campi
- `events.py`: handler che lancia eccezione non interrompe catena
- `integrations/__init__.py`: lazy-loader per entities, AttributeError

### 4.4 Stato attuale per modulo

| Modulo | Coverage prima | Coverage dopo | Target |
|--------|----------------|---------------|--------|
| `cli.py` | 0% | **94%** | >= 70% ✅ |
| `client.py` | 68% | **96%** | >= 85% ✅ |
| `auth.py` | 71% | **96%** | >= 85% ✅ |
| `events.py` | 92% | **100%** | >= 85% ✅ |
| `integrations/__init__` | 23% | **100%** | >= 85% ✅ |
| `database.py` | 81% | **85%** | >= 85% ✅ |
| `main.py` | 80% | **86%** | >= 85% ✅ |
| `repository.py` | 82% | **85%** | >= 85% ✅ |
| `compressor.py` | 77% | 77% | >= 85% ⚠️ |
| `dashboard.py` | 67% | 67% | >= 80% ⚠️ |

**Coverage globale**: 82% → **88%** (target >= 85% ✅)
**Test totali**: 242 → **295** (+53 nuovi)

- **Stato**: [x] Completato (2026-02-25) — target 85% raggiunto (88%)

---

## Fase 5 — Packaging e CI/CD (BLOCKING)

### 5.1 pyproject.toml
- [x] Cambiare classifier da `"4 - Beta"` a `"5 - Production/Stable"`
- [x] Aggiungere `Programming Language :: Python :: 3.13`
- [x] Aggiornare lower bound pytest-asyncio da `>=0.23.0` a `>=1.0.0`
- [x] Aggiungere URL `Documentation` in `[project.urls]`
- [x] Versione: `1.0.0`
- **Stato**: [x] Completato (2026-02-25)

### 5.2 CI/CD hardening
- **File**: `.github/workflows/ci.yml`
- [x] Rimuovere `|| true` da bandit e pip-audit
- [x] Cambiare warning in `exit 1` per coverage sotto 85%
- [x] Aggiungere Python 3.13 nella matrix
- [x] Installare `[mcp]` nel job coverage
- **Stato**: [x] Completato (2026-02-25)

### 5.3 Versione coerente
- [x] `pyproject.toml` → `1.0.0`
- [x] `kore_memory/config.py` VERSION → `1.0.0`
- [x] `sdk/js/package.json` → `1.0.0`
- [x] JS SDK `HealthResponse` allineato con endpoint reale (rimosso `capabilities`, aggiunto `database`)
- **Stato**: [x] Completato (2026-02-25)

---

## Fase 6 — Documentazione (NICE-TO-HAVE)

### 6.1 CLAUDE.md da aggiornare
- [x] "6 file in tests/" → "13 file, 359 test"
- [x] "MCP server espone 6 tool" → "14 tool"
- [x] `dashboard.py` ~1200 righe → `templates/dashboard.html`
- [x] `KORE_LOCAL_ONLY` default → corretto: `"1"`
- [x] `mcp_server.py` righe aggiornate (~338)
- [x] `repository.py` righe aggiornate (~979)
- [x] Aggiunto `KORE_TEST_MODE`, rate limiting, archived memories, session validation, health check patterns
- [x] Rimosso `storage.py` dalla tabella moduli
- [x] Versione aggiornata a v1.0.0
- **Stato**: [x] Completato (2026-02-25)

### 6.2 Pulizia dead code
- [x] `storage.py` — rimosso (Protocol mai implementato)
- [x] `config.LOCAL_ONLY` — verificato: e' usato in main.py e auth.py (non era dead code)
- [x] `scorer.py:67` — rimosso branch dead code `score + 0`
- **Stato**: [x] Completato (2026-02-25)

### 6.3 Miglioramenti minori
- [ ] Indice su `memories.archived_at` (performance query archivio)
- [ ] DB schema versioning con `PRAGMA user_version`
- [ ] Esportare modelli Pydantic da `__init__.py`
- [ ] Estrarre `_parse_cursor()` come helper condiviso in main.py
- [ ] Endpoint REST per `audit.cleanup_audit_log()`
- [ ] Logging strutturato JSON in produzione
- [ ] Usare `tempfile.NamedTemporaryFile` nei test invece di `mktemp()` deprecato

---

## Librerie — Stato aggiornamento (2026-02-25)

Tutte le dipendenze sono all'ultima versione PyPI:

| Dipendenza | Installata | Ultima | Note |
|---|---|---|---|
| FastAPI | 0.133.0 | 0.133.0 | Strict Content-Type attivo da 0.125+ |
| Pydantic | 2.12.5 | 2.12.5 | `Field(deprecated=True)` supportato da v2.7 |
| sentence-transformers | 5.2.3 | 5.2.3 | `encode()` stabile, v5.x retrocompatibile |
| mcp | 1.26.0 | 1.26.0 | `json_response=True` ancora supportato |
| uvicorn | 0.41.0 | 0.41.0 | — |
| httpx | 0.28.1 | 0.28.1 | — |
| pytest-asyncio | 1.3.0 | 1.3.0 | Lower bound da aggiornare a >=1.0.0 |

---

## Checklist rilascio v1.0

```
[x] Fase 1 completata (bug critici)
[x] Fase 2 completata (sicurezza)
[x] Fase 3 completata (architettura)
[x] Fase 4 completata (test 88% >= 85%)
[x] Fase 5 completata (packaging e CI)
[x] 359 test passano (erano 242)
[x] Coverage 88% >= 85%
[ ] Bandit senza finding critici
[ ] pip-audit pulito
[ ] CHANGELOG.md aggiornato
[ ] Tag v1.0.0 creato
[ ] PyPI publish verificato
[x] JS SDK v1.0.0 allineato
```
